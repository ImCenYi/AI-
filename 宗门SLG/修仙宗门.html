<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修仙宗门 - 战力增幅版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Serif SC', serif;
            background-color: #0f172a;
            color: #e2e8f0;
            overflow: hidden;
        }

        /* 3D 网格效果 */
        .sect-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
            perspective: 800px;
            padding-bottom: 2rem;
        }

        .tile {
            position: relative;
            aspect-ratio: 1;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }

        .tile:hover {
            transform: translateY(-4px) scale(1.03);
            z-index: 20;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        /* 建筑容器 */
        .building {
            position: absolute;
            inset: 2px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(4px);
        }

        /* 资源气泡动画 */
        .resource-bubble {
            animation: floatBubble 2.5s infinite ease-in-out;
            cursor: pointer;
        }
        @keyframes floatBubble {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }

        /* 属性增长特效 */
        .stat-pop {
            animation: statPopUp 1s ease-out forwards;
            position: absolute;
            pointer-events: none;
            font-weight: bold;
            z-index: 50;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }
        @keyframes statPopUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-40px) scale(1.5); opacity: 0; }
        }

        /* 霓虹光效边框 */
        .special-building {
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.2), inset 0 0 10px rgba(168, 85, 247, 0.1);
            border: 1px solid rgba(168, 85, 247, 0.5);
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    </style>
</head>
<body class="h-screen flex flex-col">

<div id="app" class="h-full flex flex-col max-w-7xl mx-auto w-full p-2 gap-2">

    <!-- 顶栏：基建资源 -->
    <div class="bg-slate-800 border border-slate-700 rounded-xl p-3 shadow-lg flex flex-wrap gap-4 items-center justify-between shrink-0 z-20">
        <div class="flex gap-6 items-center">
            <div class="flex flex-col">
                <span class="text-xs text-slate-400">宗门等级</span>
                <span class="text-xl font-bold text-yellow-500 font-mono">Lv.{{ mainHallLevel }}</span>
            </div>
            
            <div class="flex gap-3">
                <div class="resource-pill bg-slate-900 border-slate-700">
                    <i class="fas fa-gem text-blue-400"></i>
                    <div>
                        <div class="text-sm font-bold">{{ formatNum(res.stone) }}</div>
                        <div class="text-[10px] text-slate-500" v-if="prod.stone > 0">+{{ formatNum(prod.stone) }}/s</div>
                    </div>
                </div>
                <div class="resource-pill bg-slate-900 border-slate-700">
                    <i class="fas fa-tree text-green-500"></i>
                    <div>
                        <div class="text-sm font-bold">{{ formatNum(res.wood) }}</div>
                        <div class="text-[10px] text-slate-500" v-if="prod.wood > 0">+{{ formatNum(prod.wood) }}/s</div>
                    </div>
                </div>
                <div class="resource-pill bg-slate-900 border-slate-700">
                    <i class="fas fa-cubes text-gray-400"></i>
                    <div>
                        <div class="text-sm font-bold">{{ formatNum(res.iron) }}</div>
                        <div class="text-[10px] text-slate-500" v-if="prod.iron > 0">+{{ formatNum(prod.iron) }}/s</div>
                    </div>
                </div>
                <div class="resource-pill bg-slate-900 border-slate-700">
                    <i class="fas fa-users text-orange-400"></i>
                    <div>
                        <div class="text-sm font-bold">{{ population }} / {{ maxPopulation }}</div>
                        <div class="text-[10px] text-slate-500">闲: {{ idlePopulation }}</div>
                    </div>
                </div>
            </div>
        </div>

        <button @click="collectAll" class="bg-gradient-to-b from-yellow-600 to-yellow-700 hover:from-yellow-500 hover:to-yellow-600 text-white px-6 py-2 rounded-lg shadow-lg border-b-4 border-yellow-900 active:border-b-0 active:translate-y-1 transition-all flex items-center gap-2 font-bold tracking-wider">
            <i class="fas fa-hand-sparkles"></i> 一键征收
        </button>
    </div>

    <!-- 主界面 -->
    <div class="flex-1 flex gap-4 overflow-hidden relative">
        
        <!-- 左侧：宗门地图 -->
        <div class="flex-1 bg-slate-900 rounded-xl border border-slate-700 p-6 overflow-y-auto relative shadow-[inset_0_0_50px_rgba(0,0,0,0.5)] custom-scroll" @click="selectedTile = null">
            <!-- 浮动文字层 -->
            <div class="absolute inset-0 pointer-events-none z-50 overflow-hidden">
                <div v-for="text in floatTexts" :key="text.id" class="stat-pop" 
                     :style="{ left: text.x + 'px', top: text.y + 'px', color: text.color }">
                    {{ text.msg }}
                </div>
            </div>

            <div class="sect-grid max-w-5xl mx-auto mt-8">
                <div v-for="(tile, index) in mapTiles" :key="index" 
                     class="tile group cursor-pointer"
                     @click.stop="handleTileClick(index, $event)">
                    
                    <!-- 地块底座 -->
                    <div class="absolute inset-0 bg-slate-800 rounded-lg border-2 border-slate-700 group-hover:border-blue-500/50 transition-colors"></div>

                    <!-- 空地 -->
                    <div v-if="!tile.building" class="absolute inset-0 flex flex-col items-center justify-center opacity-30 group-hover:opacity-80 transition-opacity">
                        <i v-if="tile.locked" class="fas fa-lock text-red-500 text-3xl mb-1"></i>
                        <div v-else class="text-green-500 flex flex-col items-center">
                            <i class="fas fa-plus-circle text-4xl mb-1"></i>
                            <span class="text-xs font-bold">建造</span>
                        </div>
                    </div>

                    <!-- 建筑 -->
                    <div v-else class="building p-2" :class="getBuildingStyle(tile.building.type)">
                        
                        <!-- 产出气泡 -->
                        <div v-if="tile.building.storage > 0" 
                             class="resource-bubble absolute -top-4 -right-4 w-10 h-10 rounded-full flex items-center justify-center border-2 border-slate-900 shadow-xl z-30 hover:scale-110 transition-transform cursor-pointer"
                             :class="isSpecialBuilding(tile.building.type) ? 'bg-purple-600' : 'bg-yellow-500'"
                             @click.stop="collectSingle(index, $event)">
                            <i class="fas text-sm text-white" :class="getResourceIcon(tile.building.outputType)"></i>
                        </div>

                        <!-- 图标 -->
                        <i class="fas text-4xl mt-1 drop-shadow-lg transition-transform group-hover:scale-110" 
                           :class="[getBuildingIcon(tile.building.type), isSpecialBuilding(tile.building.type) ? 'text-purple-200' : 'text-white/90']"></i>
                        
                        <!-- 名字与等级 -->
                        <div class="text-center z-10 w-full mt-auto mb-1">
                            <div class="text-xs font-bold truncate px-1 rounded" :class="isSpecialBuilding(tile.building.type) ? 'bg-purple-900/50 text-purple-200' : ''">
                                {{ getBuildingName(tile.building.type) }}
                            </div>
                            <div class="text-[10px] scale-90 opacity-70 font-mono">Lv.{{ tile.building.level }}</div>
                        </div>

                        <!-- 升级中 -->
                        <div v-if="tile.building.upgrading" class="absolute inset-0 bg-black/70 rounded-lg flex flex-col items-center justify-center z-20 backdrop-blur-[2px]">
                            <i class="fas fa-tools text-yellow-400 animate-spin-slow text-2xl mb-2"></i>
                            <div class="text-[10px] text-yellow-200 font-bold">扩建中...</div>
                        </div>

                        <!-- 弟子点 -->
                        <div class="absolute top-1 left-1 flex flex-col gap-0.5">
                            <div v-for="n in tile.building.workers" :key="n" class="w-1.5 h-1.5 rounded-full bg-orange-400 shadow-[0_0_5px_orange]"></div>
                        </div>
                    </div>

                    <!-- 选中高亮 -->
                    <div v-if="selectedTile === index" class="absolute -inset-1 border-2 border-yellow-400/80 rounded-xl z-10 pointer-events-none animate-pulse shadow-[0_0_20px_rgba(250,204,21,0.3)]"></div>
                </div>
            </div>
        </div>

        <!-- 右侧：功能面板 -->
        <div class="w-80 flex flex-col gap-3 shrink-0 transition-all duration-300">
            
            <!-- 核心功能：宗门属性转化 (新) -->
            <div class="bg-gradient-to-br from-slate-800 to-slate-900 border border-purple-500/30 rounded-xl p-4 shadow-xl relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity text-6xl text-purple-500">
                    <i class="fas fa-dragon"></i>
                </div>
                <h2 class="text-lg font-bold text-purple-300 mb-3 border-b border-purple-500/30 pb-2 flex items-center">
                    <i class="fas fa-chart-line mr-2"></i> 宗门战力加成
                </h2>
                
                <div class="space-y-3">
                    <div class="flex justify-between items-center bg-slate-800/50 p-2 rounded border border-slate-700">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded bg-red-900/50 flex items-center justify-center text-red-400">
                                <i class="fas fa-sword"></i>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-xs text-gray-400">攻击加成</span>
                                <span class="text-sm font-bold text-red-300">+{{ formatNum(playerStats.attack) }}</span>
                            </div>
                        </div>
                        <div class="text-[10px] text-gray-500" v-if="prod.attack > 0">
                            +{{ formatNum(prod.attack) }}/s
                        </div>
                    </div>

                    <div class="flex justify-between items-center bg-slate-800/50 p-2 rounded border border-slate-700">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded bg-green-900/50 flex items-center justify-center text-green-400">
                                <i class="fas fa-heart"></i>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-xs text-gray-400">生命加成</span>
                                <span class="text-sm font-bold text-green-300">+{{ formatNum(playerStats.hp) }}</span>
                            </div>
                        </div>
                        <div class="text-[10px] text-gray-500" v-if="prod.hp > 0">
                            +{{ formatNum(prod.hp) }}/s
                        </div>
                    </div>

                    <div class="flex justify-between items-center bg-slate-800/50 p-2 rounded border border-slate-700">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded bg-yellow-900/50 flex items-center justify-center text-yellow-400">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-xs text-gray-400">掉落倍率</span>
                                <span class="text-sm font-bold text-yellow-300">+{{ playerStats.dropRate.toFixed(2) }}%</span>
                            </div>
                        </div>
                        <div class="text-[10px] text-gray-500" v-if="prod.dropRate > 0">
                            +{{ prod.dropRate.toFixed(3) }}%/s
                        </div>
                    </div>
                </div>
            </div>

            <!-- 操作面板 (建造/详情) -->
            <div class="flex-1 bg-slate-800 border border-slate-700 rounded-xl p-4 shadow-xl overflow-hidden flex flex-col">
                <div v-if="selectedTile !== null" class="h-full flex flex-col">
                    
                    <!-- 建造模式 -->
                    <div v-if="!currentTileData.building" class="h-full flex flex-col">
                        <div v-if="currentTileData.locked" class="text-center py-10">
                            <i class="fas fa-lock text-4xl text-gray-600 mb-4"></i>
                            <h3 class="text-lg font-bold text-gray-400">荒芜之地</h3>
                            <p class="text-xs text-gray-500 mb-6">需消耗灵石开辟灵脉</p>
                            <button @click="unlockLand" class="w-full py-2 bg-blue-700 hover:bg-blue-600 text-white rounded font-bold">
                                开辟 ({{ formatNum(unlockCost) }})
                            </button>
                        </div>
                        <div v-else class="flex flex-col h-full">
                            <h3 class="font-bold text-gray-300 mb-3 border-b border-slate-600 pb-2">选择建筑</h3>
                            <div class="flex-1 overflow-y-auto space-y-2 pr-1 custom-scroll">
                                <div v-for="b in buildList" :key="b.type" 
                                     @click="construct(b.type)"
                                     class="p-2 bg-slate-700/50 hover:bg-slate-700 border border-slate-600 hover:border-slate-500 rounded cursor-pointer transition-all group relative">
                                    <div class="flex justify-between items-start mb-1">
                                        <div class="font-bold text-sm" :class="b.special ? 'text-purple-300' : 'text-gray-200'">{{ b.name }}</div>
                                        <i class="fas text-gray-500" :class="b.icon"></i>
                                    </div>
                                    <div class="text-[10px] text-gray-400 mb-2">{{ b.desc }}</div>
                                    <div class="grid grid-cols-2 gap-y-1 text-[10px] font-mono text-gray-500">
                                        <div v-if="b.cost.stone"><i class="fas fa-gem text-blue-400"></i> {{ formatNum(b.cost.stone) }}</div>
                                        <div v-if="b.cost.wood"><i class="fas fa-tree text-green-500"></i> {{ formatNum(b.cost.wood) }}</div>
                                        <div v-if="b.cost.iron"><i class="fas fa-cubes text-gray-400"></i> {{ formatNum(b.cost.iron) }}</div>
                                        <div v-if="b.reqHall > mainHallLevel" class="text-red-400 col-span-2">需大殿Lv.{{b.reqHall}}</div>
                                    </div>
                                    <div v-if="!canAfford(b.cost) || b.reqHall > mainHallLevel" class="absolute inset-0 bg-slate-900/80 flex items-center justify-center text-red-400 text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity backdrop-blur-[1px]">不可建造</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 升级/管理模式 -->
                    <div v-else class="flex flex-col h-full">
                        <div class="text-center mb-4 pb-4 border-b border-slate-700">
                            <div class="w-16 h-16 mx-auto bg-slate-700 rounded-2xl flex items-center justify-center mb-2 shadow-inner border border-slate-600">
                                <i class="fas text-3xl" :class="[getBuildingIcon(currentBuilding.type), isSpecialBuilding(currentBuilding.type) ? 'text-purple-400' : 'text-gray-300']"></i>
                            </div>
                            <h3 class="text-xl font-bold text-white">{{ getBuildingName(currentBuilding.type) }}</h3>
                            <div class="text-xs text-yellow-500 font-mono">Lv.{{ currentBuilding.level }}</div>
                            <button @click="demolish" class="text-[10px] text-red-500 hover:text-red-300 mt-2 underline">拆除建筑</button>
                        </div>

                        <div class="space-y-4 mb-4 flex-1">
                            <!-- 产出信息 -->
                            <div v-if="currentBuilding.outputType" class="bg-slate-900/50 p-3 rounded border border-slate-700">
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-gray-400">当前产出</span>
                                    <span class="font-bold" :class="getOutputColor(currentBuilding.outputType)">
                                        {{ formatNum(currentProduction) }} 
                                        <span v-if="isAttributeOutput(currentBuilding.outputType)">/次</span>
                                        <span v-else>/秒</span>
                                    </span>
                                </div>
                                <div class="flex justify-between text-xs" v-if="currentBuilding.cap">
                                    <span class="text-gray-400">存储容量</span>
                                    <span class="text-gray-300">{{ formatNum(currentBuilding.storage) }} / {{ formatNum(currentCap) }}</span>
                                </div>
                                <div class="w-full bg-gray-700 h-1 mt-2 rounded-full overflow-hidden" v-if="currentBuilding.cap">
                                    <div class="h-full bg-blue-500 transition-all duration-500" :style="{width: (currentBuilding.storage/currentCap*100)+'%'}"></div>
                                </div>
                            </div>

                            <!-- 弟子管理 -->
                            <div class="bg-slate-900/50 p-3 rounded border border-slate-700">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-xs text-gray-400">入驻弟子 (效率+{{currentBuilding.workers * 50}}%)</span>
                                    <span class="text-xs font-bold text-orange-400">{{ currentBuilding.workers }}/5</span>
                                </div>
                                <div class="flex gap-2">
                                    <button @click="adjustWorker(-1)" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-1 rounded text-xs">-</button>
                                    <button @click="adjustWorker(1)" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-1 rounded text-xs" :disabled="idlePopulation <= 0">+</button>
                                </div>
                            </div>
                        </div>

                        <!-- 升级按钮 -->
                        <div class="mt-auto">
                            <button v-if="!currentBuilding.upgrading && !isMaxLevel" 
                                    @click="upgradeBuilding"
                                    class="w-full py-3 bg-blue-700 hover:bg-blue-600 text-white rounded font-bold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex flex-col items-center justify-center gap-1"
                                    :disabled="!canAfford(upgradeCost)">
                                <span>升级 (Lv.{{ currentBuilding.level + 1 }})</span>
                                <div class="text-[10px] font-mono opacity-80 flex gap-2">
                                    <span v-if="upgradeCost.stone"><i class="fas fa-gem"></i> {{ formatNum(upgradeCost.stone) }}</span>
                                    <span v-if="upgradeCost.wood"><i class="fas fa-tree"></i> {{ formatNum(upgradeCost.wood) }}</span>
                                    <span v-if="upgradeCost.iron"><i class="fas fa-cubes"></i> {{ formatNum(upgradeCost.iron) }}</span>
                                </div>
                            </button>
                            <div v-else-if="currentBuilding.upgrading" class="w-full py-3 bg-slate-700 text-yellow-400 text-center rounded border border-dashed border-yellow-500/50 text-xs cursor-pointer" @click="finishUpgrade">
                                <i class="fas fa-hard-hat mr-1"></i> 建设中 (点击加速)
                            </div>
                            <div v-else class="w-full py-3 bg-slate-800 text-gray-500 text-center rounded border border-slate-700 text-xs">
                                已达最高等级
                            </div>
                        </div>
                    </div>
                </div>
                
                <div v-else class="h-full flex items-center justify-center text-gray-500 flex-col opacity-50">
                    <i class="fas fa-mouse-pointer text-4xl mb-2"></i>
                    <p class="text-xs">选择地块查看详情</p>
                </div>
            </div>
        </div>

    </div>

    <!-- 日志 -->
    <div class="h-24 bg-slate-900 border-t border-slate-700 p-2 overflow-y-auto text-[10px] font-mono text-gray-400 shrink-0 custom-scroll">
        <div v-for="(log, i) in logs" :key="i" class="mb-0.5">
            <span class="text-slate-600">[{{ log.time }}]</span> <span :class="log.color">{{ log.msg }}</span>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted, reactive } = Vue;

    // 建筑配置表
    const BUILDINGS = {
        // 基础基建
        hall:   { name: "宗门大殿", icon: "fa-dungeon", desc: "核心建筑，提升等级上限", output: null },
        house:  { name: "弟子精舍", icon: "fa-bed", desc: "增加弟子上限", output: "pop" },
        farm:   { name: "百草药园", icon: "fa-seedling", desc: "产出灵石", output: "stone" },
        forest: { name: "灵木林场", icon: "fa-tree", desc: "产出灵木", output: "wood" },
        mine:   { name: "玄铁矿脉", icon: "fa-hammer", desc: "产出玄铁", output: "iron" },
        
        // 特殊属性建筑 (转化器)
        sword:  { name: "万剑冢", icon: "fa-sword", desc: "产出剑意，提升主角攻击力", output: "attack", special: true },
        life:   { name: "长生树", icon: "fa-leaf", desc: "产出精华，提升主角生命值", output: "hp", special: true },
        luck:   { name: "天机阁", icon: "fa-eye", desc: "窥探天机，提升掉落倍率", output: "dropRate", special: true },
    };

    createApp({
        setup() {
            // 基础资源
            const res = reactive({ stone: 1000, wood: 500, iron: 0 });
            const population = ref(5);
            
            // 主角属性 (局外属性)
            const playerStats = reactive({
                attack: 0,
                hp: 0,
                dropRate: 0
            });

            // 地图数据 (6x6)
            const mapTiles = ref(Array.from({ length: 36 }, (_, i) => ({
                id: i,
                locked: i > 15,
                building: null
            })));

            // 初始大殿
            mapTiles.value[8].building = { type: 'hall', level: 1, workers: 0, storage: 0, upgrading: false, maxStorage: 0 };

            const selectedTile = ref(null);
            const logs = ref([]);
            const floatTexts = ref([]);

            // 计算属性
            const mainHallLevel = computed(() => {
                const hall = mapTiles.value.find(t => t.building?.type === 'hall');
                return hall ? hall.building.level : 0;
            });

            const maxPopulation = computed(() => {
                const houses = mapTiles.value.filter(t => t.building?.type === 'house');
                return 5 + houses.reduce((sum, h) => sum + (h.building.level * 5), 0);
            });

            const assignedWorkers = computed(() => mapTiles.value.reduce((sum, t) => sum + (t.building?.workers || 0), 0));
            const idlePopulation = computed(() => population.value - assignedWorkers.value);

            const currentTileData = computed(() => selectedTile.value !== null ? mapTiles.value[selectedTile.value] : null);
            const currentBuilding = computed(() => currentTileData.value?.building);

            // 产出预览
            const prod = computed(() => {
                const p = { stone: 0, wood: 0, iron: 0, attack: 0, hp: 0, dropRate: 0 };
                mapTiles.value.forEach(t => {
                    const b = t.building;
                    if (b && !b.upgrading && b.outputType && b.outputType !== 'pop') {
                        let base = getBaseOutput(b.type) * b.level;
                        let workerBonus = b.workers * 0.5;
                        p[b.outputType] += base * (1 + workerBonus);
                    }
                });
                return p;
            });

            // 建造列表
            const buildList = computed(() => [
                { type: 'farm', name: '百草药园', icon: 'fa-seedling', desc: '产出灵石', cost: { stone: 100, wood: 20 }, reqHall: 1 },
                { type: 'forest', name: '灵木林场', icon: 'fa-tree', desc: '产出灵木', cost: { stone: 50, wood: 0 }, reqHall: 1 },
                { type: 'house', name: '弟子精舍', icon: 'fa-bed', desc: '增加人口', cost: { stone: 200, wood: 100 }, reqHall: 1 },
                { type: 'mine', name: '玄铁矿脉', icon: 'fa-hammer', desc: '产出玄铁', cost: { stone: 500, wood: 300 }, reqHall: 2 },
                
                // 特殊建筑
                { type: 'sword', name: '万剑冢', icon: 'fa-sword', desc: '转化攻击力', cost: { stone: 2000, wood: 1000, iron: 200 }, reqHall: 3, special: true },
                { type: 'life', name: '长生树', icon: 'fa-leaf', desc: '转化生命值', cost: { stone: 2000, wood: 1000, iron: 200 }, reqHall: 3, special: true },
                { type: 'luck', name: '天机阁', icon: 'fa-eye', desc: '转化掉落率', cost: { stone: 5000, wood: 2000, iron: 500 }, reqHall: 4, special: true },
            ]);

            const upgradeCost = computed(() => {
                if (!currentBuilding.value) return {};
                const lv = currentBuilding.value.level;
                const type = currentBuilding.value.type;
                const factor = type === 'hall' ? 5 : (isSpecialBuilding(type) ? 3 : 1.5);
                return {
                    stone: Math.floor(100 * Math.pow(1.6, lv) * factor),
                    wood: Math.floor(50 * Math.pow(1.6, lv) * factor),
                    iron: lv > 2 ? Math.floor(10 * Math.pow(1.6, lv) * factor) : 0
                };
            });

            const currentProduction = computed(() => {
                if (!currentBuilding.value) return 0;
                return getBaseOutput(currentBuilding.value.type) * currentBuilding.value.level * (1 + currentBuilding.value.workers * 0.5);
            });

            const currentCap = computed(() => currentBuilding.value ? currentBuilding.value.level * (isSpecialBuilding(currentBuilding.value.type) ? 100 : 500) : 0);
            
            const isMaxLevel = computed(() => {
                if (!currentBuilding.value) return false;
                if (currentBuilding.value.type !== 'hall' && currentBuilding.value.level >= mainHallLevel.value) return true;
                return currentBuilding.value.level >= 20;
            });

            const unlockCost = computed(() => {
                const c = mapTiles.value.filter(t => !t.locked).length;
                return Math.floor(500 * Math.pow(1.2, c - 16));
            });

            // 核心方法
            function getBaseOutput(type) {
                const map = { farm: 5, forest: 3, mine: 1, sword: 10, life: 100, luck: 0.01 };
                return map[type] || 0;
            }

            function construct(type) {
                const item = buildList.value.find(b => b.type === type);
                if (canAfford(item.cost)) {
                    pay(item.cost);
                    mapTiles.value[selectedTile.value].building = {
                        type: type,
                        level: 1,
                        workers: 0,
                        storage: 0,
                        upgrading: true,
                        outputType: BUILDINGS[type].output,
                        maxStorage: isSpecialBuilding(type) ? 100 : 500
                    };
                    addLog(`开始建造 [${item.name}]`, 'text-yellow-400');
                    setTimeout(() => { 
                        if(mapTiles.value[selectedTile.value].building) 
                            mapTiles.value[selectedTile.value].building.upgrading = false; 
                    }, 2000);
                }
            }

            function collectSingle(index, event) {
                const b = mapTiles.value[index].building;
                if (b && b.storage > 0) {
                    const amount = b.storage;
                    const type = b.outputType;
                    
                    if (isAttributeOutput(type)) {
                        playerStats[type] += amount;
                        addFloat(event.clientX, event.clientY, `+${formatNum(amount)} ${getAttributeName(type)}`, '#a855f7');
                        addLog(`汲取 [${getBuildingName(b.type)}] 获得 ${formatNum(amount)} ${getAttributeName(type)}`, 'text-purple-400');
                    } else if (type !== 'pop') {
                        res[type] += amount;
                        addFloat(event.clientX, event.clientY, `+${formatNum(amount)}`, '#fbbf24');
                        addLog(`征收 [${getBuildingName(b.type)}] 获得 ${formatNum(amount)} ${getResourceName(type)}`);
                    }
                    b.storage = 0;
                }
            }

            function collectAll() {
                let count = 0;
                mapTiles.value.forEach((t, idx) => {
                    const b = t.building;
                    if (b && b.storage > 0 && b.outputType !== 'pop') {
                        if (isAttributeOutput(b.outputType)) {
                            playerStats[b.outputType] += b.storage;
                        } else {
                            res[b.outputType] += b.storage;
                        }
                        b.storage = 0;
                        count++;
                    }
                });
                if (count > 0) addLog(`一键征收完成，宗门资源已入库`, 'text-green-400');
            }

            // 辅助逻辑
            function isSpecialBuilding(type) { return ['sword', 'life', 'luck'].includes(type); }
            function isAttributeOutput(type) { return ['attack', 'hp', 'dropRate'].includes(type); }
            
            function getAttributeName(type) {
                return { attack: '攻击', hp: '生命', dropRate: '倍率' }[type];
            }
            
            function upgradeBuilding() {
                if (canAfford(upgradeCost.value)) {
                    pay(upgradeCost.value);
                    currentBuilding.value.upgrading = true;
                    setTimeout(finishUpgrade, 3000);
                }
            }
            
            function finishUpgrade() {
                if (currentBuilding.value) {
                    currentBuilding.value.upgrading = false;
                    currentBuilding.value.level++;
                    currentBuilding.value.maxStorage = currentBuilding.value.level * (isSpecialBuilding(currentBuilding.value.type) ? 100 : 500);
                }
            }

            function demolish() {
                if (confirm('确定拆除？资源返还50%')) {
                    mapTiles.value[selectedTile.value].building = null;
                    selectedTile.value = null;
                }
            }

            function handleTileClick(index, e) { selectedTile.value = index; }
            function unlockLand() { 
                if(res.stone >= unlockCost.value) {
                    res.stone -= unlockCost.value;
                    mapTiles.value[selectedTile.value].locked = false;
                }
            }
            function adjustWorker(d) {
                if(!currentBuilding.value) return;
                if(d>0 && idlePopulation.value>0 && currentBuilding.value.workers < 5) currentBuilding.value.workers++;
                if(d<0 && currentBuilding.value.workers > 0) currentBuilding.value.workers--;
            }
            function canAfford(c) {
                return res.stone >= (c.stone||0) && res.wood >= (c.wood||0) && res.iron >= (c.iron||0);
            }
            function pay(c) {
                if(c.stone) res.stone -= c.stone;
                if(c.wood) res.wood -= c.wood;
                if(c.iron) res.iron -= c.iron;
            }
            
            // 样式与文本
            function getBuildingStyle(type) {
                if(isSpecialBuilding(type)) return 'bg-slate-800 special-building text-purple-100';
                if(type === 'hall') return 'bg-yellow-900 border-yellow-600 text-yellow-100';
                return 'bg-slate-700 border-slate-600 text-gray-200';
            }
            function getBuildingIcon(type) { return BUILDINGS[type]?.icon; }
            function getBuildingName(type) { return BUILDINGS[type]?.name; }
            function getResourceIcon(type) { return {stone:'fa-gem', wood:'fa-tree', iron:'fa-cubes', attack:'fa-sword', hp:'fa-heart', dropRate:'fa-star'}[type]; }
            function getResourceName(type) { return {stone:'灵石', wood:'灵木', iron:'玄铁'}[type]; }
            function getOutputColor(type) { return isAttributeOutput(type) ? 'text-purple-400' : 'text-green-400'; }
            
            function formatNum(n) {
                if (n >= 10000) return (n/10000).toFixed(1) + '万';
                return Math.floor(n);
            }
            
            function addLog(msg, color = 'text-gray-400') {
                logs.value.unshift({ time: new Date().toLocaleTimeString(), msg, color });
                if(logs.value.length > 20) logs.value.pop();
            }

            function addFloat(x, y, msg, color) {
                const id = Date.now() + Math.random();
                floatTexts.value.push({ id, x, y, msg, color });
                setTimeout(() => floatTexts.value = floatTexts.value.filter(t => t.id !== id), 1000);
            }

            // 循环
            onMounted(() => {
                setInterval(() => {
                    // 人口
                    if (population.value < maxPopulation.value && Math.random() < 0.1) population.value++;
                    
                    // 产出
                    mapTiles.value.forEach(t => {
                        const b = t.building;
                        if (b && !b.upgrading && b.outputType) {
                            let base = getBaseOutput(b.type) * b.level;
                            let bonus = b.workers * 0.5;
                            let val = base * (1 + bonus);
                            if (b.storage < b.maxStorage) b.storage = Math.min(b.maxStorage, b.storage + val);
                        }
                    });
                }, 1000);
            });

            return {
                res, population, maxPopulation, idlePopulation, playerStats,
                mainHallLevel, mapTiles, selectedTile, currentTileData, currentBuilding,
                buildList, upgradeCost, currentProduction, currentCap, isMaxLevel, unlockCost,
                logs, floatTexts, prod,
                handleTileClick, construct, upgradeBuilding, finishUpgrade, demolish,
                unlockLand, adjustWorker, collectSingle, collectAll, canAfford,
                getBuildingStyle, getBuildingIcon, getBuildingName, getResourceIcon, 
                formatNum, isSpecialBuilding, isAttributeOutput, getOutputColor
            };
        }
    }).mount('#app');
</script>
<style>
    .resource-pill {
        @apply flex items-center gap-2 px-3 py-1 rounded;
    }
    .custom-scroll::-webkit-scrollbar { width: 4px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }
</style>
</body>
</html>