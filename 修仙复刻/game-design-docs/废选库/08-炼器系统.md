# 炼器系统 - 装备强化与洗练

## 🎯 核心定位

**系统名称**：玄天炼器炉  
**核心体验**：DNF式强化 + MMO洗词条 + 造梦合石头的混合赌博体验  
**最小开发成本**：复用现有装备系统 + 简单概率计算 + 模态框UI

---

## 🎮 核心机制（最简单形式）

### 1. 装备强化（+1 到 +15）

```javascript
const ENHANCE_SYSTEM = {
    // 强化等级
    maxLevel: 15,
    
    // 成功率表（递减）
    successRate: {
        0: 1.0,   // +0→+1: 100%
        1: 0.9,   // +1→+2: 90%
        2: 0.8,   // +2→+3: 80%
        3: 0.7,   // +3→+4: 70%
        4: 0.6,   // +4→+5: 60%
        5: 0.5,   // +5→+6: 50%
        6: 0.4,   // +6→+7: 40%
        7: 0.3,   // +7→+8: 30%
        8: 0.25,  // +8→+9: 25%
        9: 0.2,   // +9→+10: 20%
        10: 0.15, // +10→+11: 15%
        11: 0.1,  // +11→+12: 10%
        12: 0.08, // +12→+13: 8%
        13: 0.05, // +13→+14: 5%
        14: 0.03  // +14→+15: 3%
    },
    
    // 失败惩罚（+7开始）
    failPenalty: {
        0: 'none',     // 无惩罚
        1: 'none',
        2: 'none',
        3: 'none',
        4: 'none',
        5: 'none',
        6: 'none',
        7: 'downgrade', // +7开始失败降级
        8: 'downgrade',
        9: 'downgrade',
        10: 'reset',    // +10开始失败归零
        11: 'reset',
        12: 'reset',
        13: 'destroy',  // +13开始可能碎装备
        14: 'destroy'
    },
    
    // 属性加成（每级+10%基础属性）
    statBonus: (level) => 1 + (level * 0.1)  // +15 = 250%属性
};
```

### 2. 词条洗练（3条随机词条）

```javascript
const AFFIX_SYSTEM = {
    // 每个装备可有3条词条
    maxAffixes: 3,
    
    // 词条类型
    affixTypes: [
        { id: 'atk_pct', name: '攻击加成', min: 1, max: 20, unit: '%' },
        { id: 'hp_pct', name: '生命加成', min: 1, max: 20, unit: '%' },
        { id: 'crit', name: '暴击率', min: 1, max: 15, unit: '%' },
        { id: 'crit_dmg', name: '暴击伤害', min: 5, max: 50, unit: '%' },
        { id: 'atk_spd', name: '攻击速度', min: 1, max: 20, unit: '%' },
        { id: 'drop', name: '掉落率', min: 1, max: 10, unit: '%' },
        { id: 'exp', name: '经验加成', min: 1, max: 15, unit: '%' }
    ],
    
    // 洗练规则
    reroll: {
        cost: 100,  // 每次消耗材料
        lockCost: 50, // 锁定一条词条额外消耗
        keepBest: true // 可以选择保留原词条或新词条
    }
};
```

---

## 📦 材料来源（新建副本）

### 炼器副本 - "玄铁矿洞"

```javascript
const FORGE_DUNGEON = {
    name: '玄铁矿洞',
    unlockLevel: 20,  // 境界20解锁
    
    // 副本机制
    waves: 5,  // 5波敌人
    timeLimit: 120, // 2分钟限时
    
    // 产出
    rewards: {
        // 基础材料
        '玄铁矿石': { base: 10, perWave: 5 },
        
        // 强化材料
        '初级强化石': { chance: 0.5, perWave: 2 },
        '中级强化石': { chance: 0.2, perWave: 1 },
        '高级强化石': { chance: 0.05, perWave: 1 },
        
        // 洗练材料
        '洗练符': { chance: 0.3, perWave: 1 },
        '锁定符': { chance: 0.1, perWave: 1 },
        
        // 保护材料（稀有）
        '保护符': { chance: 0.05, perWave: 0.5 }, // 防止碎装备
        '幸运符': { chance: 0.03, perWave: 0.3 }  // +10%成功率
    },
    
    // 难度递增
    difficultyScale: 1.5,  // 每层难度×1.5
    maxFloor: 10  // 10层
};
```

### 材料用途

| 材料 | 用途 | 获取 |
|-----|------|------|
| 玄铁矿石 | 强化1-5级 | 矿洞基础掉落 |
| 初级强化石 | 强化6-10级 | 矿洞50%掉落 |
| 中级强化石 | 强化11-13级 | 矿洞20%掉落 |
| 高级强化石 | 强化14-15级 | 矿洞5%掉落 |
| 洗练符 | 洗词条 | 矿洞30%掉落 |
| 锁定符 | 锁定词条 | 矿洞10%掉落 |
| 保护符 | 防碎装备 | 矿洞5%掉落 |
| 幸运符 | +10%成功率 | 矿洞3%掉落 |

---

## 📊 数值设计

### 强化数值（最小开发成本）

```javascript
// 强化只影响装备基础数值
// +15装备 = 原属性 × 2.5

function applyEnhancement(equipment, level) {
    const multiplier = 1 + (level * 0.1);
    return {
        atk: equipment.atk.mul(multiplier),
        hp: equipment.hp.mul(multiplier)
    };
}
```

### 词条数值（指数增长）

```javascript
// 词条使用BigNum，后期也有用
const AFFIX_TIERS = {
    // 普通词条（1-10%）
    common: { weight: 60, mult: [0.01, 0.1] },
    // 稀有词条（11-20%）
    rare: { weight: 30, mult: [0.11, 0.2] },
    // 传说词条（21-50%）
    legendary: { weight: 9, mult: [0.21, 0.5] },
    // 神话词条（指数级）
    mythic: { weight: 1, mult: [2, 5] }  // ×2 到 ×5
};
```

---

## 🔄 迭代路线图

### Phase 1 - 基础强化（1周）
- 强化+1到+15
- 基础成功率
- 失败降级/归零
- 玄铁矿洞副本

### Phase 2 - 保护机制（3天）
- 保护符（防碎）
- 幸运符（+成功率）
- 强化保底（连续失败+成功率）

### Phase 3 - 词条系统（1周）
- 3条随机词条
- 洗练功能
- 锁定符

### Phase 4 - 高级玩法（1周）
- 套装词条（2件/4件效果）
- 词条转移（A装备→B装备）
- 词条觉醒（突破上限）

### Phase 5 - 社交元素（1周）
- 强化排行榜
- 强化大师称号
- 强化记录分享

---

## 💰 商业化

### 付费点

```
1. 强化材料礼包
   - 小包（6元）：100个初级强化石
   - 大包（30元）：50个中级强化石 + 10个保护符

2. 保护符
   - 单买（3元/个）：防止碎装备
   - 这是核心付费点，高强化必买

3. 锁定符
   - 单买（2元/个）：锁定好词条
   - 洗练玩家刚需

4. 快速通关
   - 扫荡券（1元/张）：快速打矿洞

5. 保底强化券
   - 必成券（68元）：100%成功一次（限+10以下）
```

---

## 🎨 UI设计（最小成本）

### 炼器炉界面

```
┌─────────────────────────────────────────────────┐
│  ⚔️ 玄天炼器炉                                    │
├─────────────────────────────────────────────────┤
│                                                  │
│  【选择装备】                                     │
│  ┌─────────────────────────────────────────┐    │
│  │ 🗡️ 破风剑 (+7) [史诗]                  │    │
│  │ 攻击: 1.5K → 2.1K (+40%)               │    │
│  │ 词条1: 攻击+15% [锁定🔒]               │    │
│  │ 词条2: 暴击+8%                         │
│  │ 词条3: 空                              │
│  └─────────────────────────────────────────┘    │
│                                                  │
│  【强化】 (+7 → +8)                              │
│  成功率: 30%  失败: 降级到+6                      │
│  消耗: 中级强化石×5  保护符×0                    │
│  [勾选使用保护符] [勾选使用幸运符]               │
│                                                  │
│  [开始强化]  🔥  [洗练词条]  🔮                  │
│                                                  │
│  强化记录:                                       │
│  [+7] 失败 降级到+6  12:30                      │
│  [+6] 成功 → +7      12:28                      │
│  [+6] 失败 保持+6    12:25                      │
└─────────────────────────────────────────────────┘
```

---

## 🔧 技术实现

### 新增文件

```
js/
├── classes/
│   └── EquipmentEnhancement.js  # 强化系统类
├── config/
│   └── forge-config.js          # 强化配置
└── game/
    └── ForgeSystem.js           # 炼器系统管理
```

### 装备数据扩展

```javascript
// 在原有Item基础上扩展
class EnhancedItem extends Item {
    constructor(difficulty, type) {
        super(difficulty, type);
        this.enhanceLevel = 0;      // 强化等级
        this.affixes = [];          // 3条词条
    }
    
    getTotalStats() {
        let stats = {
            atk: this.atk,
            hp: this.hp
        };
        
        // 应用强化加成
        const enhanceMult = 1 + (this.enhanceLevel * 0.1);
        stats.atk = stats.atk.mul(enhanceMult);
        stats.hp = stats.hp.mul(enhanceMult);
        
        // 应用词条加成
        this.affixes.forEach(affix => {
            if (affix.type === 'atk_pct') {
                stats.atk = stats.atk.mul(1 + affix.value / 100);
            }
            // ... 其他词条
        });
        
        return stats;
    }
}
```

---

## ✅ 验收标准

- [ ] 装备可以强化到+15
- [ ] 强化成功率按表格执行
- [ ] +7开始失败降级，+10开始失败归零
- [ ] 装备可以洗出3条词条
- [ ] 词条数值正确应用
- [ ] 玄铁矿洞副本正常产出材料
- [ ] 保护符/幸运符效果正确
- [ ] 强化记录显示正确

---

## 🎯 设计亮点

1. **最小成本**：复用现有装备系统，只增加2个字段（enhanceLevel, affixes）
2. **强赌博感**：成功率递减 + 严重失败惩罚 = 刺激
3. **深度养成**：+15装备 + 完美词条 = 长期追求
4. **材料循环**：副本产出 → 强化消耗 → 失败回收材料（部分）
5. **付费合理**：保护符是刚需但不强制，零氪也能靠肝
