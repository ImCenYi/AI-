# 百草灵园系统 (Spirit Garden System)

## 📋 系统概述

**系统名称**：百草灵园  
**参考原型**：种田系统02_数值平衡版  
**解锁条件**：练气-初期（境界1+）  
**核心目的**：提供放置式资源产出，与修仙主循环形成互补  
**系统定位**：贯穿全程的基础资源产出系统，强调"种田修仙"的休闲体验

---

## 🎮 核心机制（参考原系统）

### 1. 土地系统

```javascript
const LAND_SYSTEM = {
    maxLands: 16,           // 最大16块土地
    initialLands: 4,        // 初始解锁4块
    unlockCostFormula: (index) => new BigNum(200).mul(new BigNum(2.5).pow(index))
    // 成本：200, 500, 1250, 3125, 7812...
};
```

**土地状态**：
- 未解锁：花费灵石开辟
- 空闲：可种植
- 生长中：显示进度条
- 成熟：可收获，有发光提示

### 2. 灵植系统（10转×7种=70种作物）

```javascript
// 基础种子（凡阶）
const BASE_CROPS = [
    { id: 1, name: "凝气草",   quality: 0, icon: "🌿", time: 3,    cost: 10,     income: 15,      exp: 5,       reqLevel: 1 },
    { id: 2, name: "血菩提",   quality: 1, icon: "🍒", time: 10,   cost: 100,    income: 250,     exp: 25,      reqLevel: 3 },
    { id: 3, name: "玄冰花",   quality: 2, icon: "❄️", time: 30,   cost: 800,    income: 2400,    exp: 120,     reqLevel: 10 },
    { id: 4, name: "紫金藤",   quality: 3, icon: "🎋", time: 60,   cost: 3000,   income: 10000,   exp: 400,     reqLevel: 25 },
    { id: 5, name: "龙鳞果",   quality: 4, icon: "🐲", time: 120,  cost: 15000,  income: 60000,   exp: 1500,    reqLevel: 45 },
    { id: 6, name: "悟道茶",   quality: 5, icon: "🍵", time: 300,  cost: 80000,  income: 400000,  exp: 6000,    reqLevel: 65 },
    { id: 7, name: "混沌莲",   quality: 5, icon: "🪷", time: 600,  cost: 500000, income: 3000000, exp: 20000,   reqLevel: 80 },
];

// 转生倍率公式
function generateTurnCrops(turn) {
    const multiplier = new BigNum(100).pow(turn);  // 每转×100倍
    
    return BASE_CROPS.map(crop => ({
        ...crop,
        id: crop.id + turn * 1000,
        name: turn === 0 ? crop.name : `${turn}转·${crop.name}`,
        cost: crop.cost.mul(multiplier),
        income: crop.income.mul(multiplier),
        exp: crop.exp.mul(multiplier),  // 经验也×100倍
        reqLevel: crop.reqLevel + turn * 100
    }));
}
```

### 3. 灵植园等级系统

```javascript
// 灵植园等级独立计算
const GARDEN_LEVEL_FORMULA = {
    // 升级所需经验指数增长
    maxExp: (level) => new BigNum(100).mul(new BigNum(1.0475).pow(level)),
    
    // 每100级为1转，共10转
    getTurn: (level) => Math.floor((level - 1) / 100),
    
    // 转生解锁新种子商店层级
    unlockShopTurn: (level) => {
        const turn = Math.floor((level - 1) / 100);
        return Math.min(9, turn);
    }
};
```

### 4. 傀儡托管系统（自动化）

```javascript
const PUPPET_SYSTEM = {
    unlockLevel: 2,  // 灵植园2级解锁
    
    functions: {
        autoHarvest: true,   // 自动收获成熟作物
        autoPlant: true      // 自动种植上次作物
    },
    
    // 傀儡升级（可选扩展）
    upgrades: {
        efficiency: { cost: 1000, effect: 1.1 },    // 收获效率+10%
        intelligence: { cost: 5000, effect: 1.2 },  // 选择最优作物
        speed: { cost: 10000, effect: 0.9 }         // 生长时间-10%
    }
};
```

### 5. 丹火提炼（增益系统）

```javascript
const ALCHEMY_MODE = {
    unlockLevel: 10,  // 灵植园10级解锁
    effect: 1.2,      // +20%收益
    cost: 0,          // 无维持成本，纯解锁福利
    description: "将灵植炼化为丹药，收益提升20%"
};
```

---

## 🔗 与修仙系统的融合

### 资源转换机制

```javascript
// 百草灵园产出 → 修仙资源
const RESOURCE_CONVERSION = {
    // 1. 灵石直接获取
    spiritStones: {
        source: 'cropIncome',  // 出售灵植获得
        usage: ['landUnlock', 'seedPurchase', 'facilityUpgrade']
    },
    
    // 2. 灵植园经验 → 法则真意（主要产出）
    gardenExpToLaw: {
        rate: 0.1,  // 每10点灵植经验 = 1点法则真意
        unlockAt: 'lawTab',  // 解锁法则修炼后开启
        description: "灵植悟道，感悟天地法则"
    },
    
    // 3. 灵植园等级 → 境界突破辅助
    realmAssist: {
        effect: (gardenLevel) => {
            // 灵植园每100级，境界突破时额外+1%属性
            return Math.floor(gardenLevel / 100) * 0.01;
        }
    },
    
    // 4. 高阶灵植 → 秘宝材料（后期）
    highTierCrops: {
        unlockTurn: 3,  // 3转后解锁
        conversion: {
            '3转·混沌莲': 'treasureFragment',  // 可兑换秘宝碎片
            '4转·混沌莲': 'treasureChest'      // 可兑换秘宝宝箱
        }
    }
};
```

### 与现有系统的联动

```
┌─────────────────────────────────────────────────────────────┐
│                     百草灵园联动图                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌──────────────┐                                          │
│   │  百草灵园     │                                          │
│   │  (种植灵植)   │                                          │
│   └──────┬───────┘                                          │
│          │                                                  │
│    ┌─────┼─────┬──────────┬──────────┐                     │
│    ↓     ↓     ↓          ↓          ↓                     │
│ ┌────┐┌────┐┌────┐   ┌──────┐   ┌────────┐                │
│ │灵石││法则││境界│   │秘宝  │   │丹药    │                │
│ │    ││真意││辅助│   │材料  │   │炼制    │                │
│ └────┘└────┘└────┘   └──────┘   └────────┘                │
│   │     │     │         │          │                       │
│   ↓     ↓     ↓         ↓          ↓                       │
│ ┌────┐┌────┐┌────┐   ┌──────┐   ┌────────┐                │
│ │土地││法则││境界│   │秘宝  │   │战斗    │                │
│ │解锁││修炼││突破│   │系统  │   │buff    │                │
│ └────┘└────┘└────┘   └──────┘   └────────┘                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 📊 数值平衡设计

### 原系统数值 → BigNum适配

```javascript
// 原系统使用普通数字，修仙游戏使用BigNum
class SpiritGarden {
    constructor() {
        this.gardenLevel = 1;
        this.gardenExp = new BigNum(0);
        this.spiritStones = new BigNum(100);  // 初始100灵石
        this.turn = 0;  // 当前转数
        
        this.lands = Array(16).fill(null).map((_, i) => ({
            unlocked: i < 4,
            unlockCost: new BigNum(200).mul(new BigNum(2.5).pow(i)),
            plant: null,
            progress: 0
        }));
    }
    
    // 计算当前转数对应的倍率
    getTurnMultiplier(turn) {
        return new BigNum(100).pow(turn);
    }
    
    // 获取当前可购买的种子列表
    getAvailableSeeds() {
        const turn = this.turn;
        const mult = this.getTurnMultiplier(turn);
        
        return BASE_CROPS.map(crop => ({
            ...crop,
            cost: new BigNum(crop.cost).mul(mult),
            income: new BigNum(crop.income).mul(mult),
            exp: new BigNum(crop.exp).mul(mult)
        })).filter(crop => crop.reqLevel <= this.gardenLevel);
    }
    
    // 升级所需经验
    getMaxExp() {
        // 指数增长，但比原系统更平缓（适配长期游戏）
        return new BigNum(100).mul(new BigNum(1.05).pow(this.gardenLevel));
    }
}
```

### 产出速率控制

```javascript
// 目标：灵植园产出是修仙资源的补充，而非主要来源
const PRODUCTION_RATIO = {
    // 法则真意来源占比目标：
    // - 通天塔：60%（主动玩法）
    // - 灵植园：30%（放置产出）
    // - 其他：10%
    
    lawFragments: {
        gardenContribution: 0.3,
        
        // 平衡公式：假设玩家平均在线4小时
        // 4小时 = 240分钟 = 14400秒
        // 平均种植3转·玄冰花（30秒×100^3 = 30,000,000秒？不对）
        
        // 重新设计：生长时间随转数增加，但收益也增加
        // 保持"单位时间收益"合理
        
        balanceFormula: (playerRealm) => {
            // 灵植园产出 ≈ 玩家当前境界通天塔产出的30%
            const towerIncome = calculateTowerIncome(playerRealm);
            return towerIncome.mul(0.3);
        }
    }
};
```

### 转生平衡

```javascript
// 关键设计：灵植园转生与境界突破联动
const REINCARNATION_LINK = {
    // 当玩家转世时，灵植园可选择：
    // 选项1：重置灵植园（获得转世印记加成）
    // 选项2：保留灵植园等级（消耗往生记忆道具）
    
    onPlayerReincarnation: (choice) => {
        if (choice === 'reset') {
            // 根据灵植园等级获得额外印记
            const bonusMarks = gardenLevel * 10;
            return { bonusMarks, resetGarden: true };
        } else {
            // 保留等级，但种子商店回到凡阶
            return { bonusMarks: 0, resetGarden: false, resetShop: true };
        }
    }
};
```

---

## 🎨 UI设计

### 百草灵园界面布局

```
┌─────────────────────────────────────────────────────────────┐
│  百草灵园                             Lv.125 (1转)   💎1.5M  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────┐           │
│  │                                             │           │
│  │              4×4 土地网格                    │           │
│  │                                             │           │
│  │  🌿[████]  🍒[██  ]  ❄️[    ]  🎋[    ]  │           │
│  │   生长中    生长中    空闲      空闲        │           │
│  │                                             │           │
│  │  🐲[✨]    🍵[✨]    🪷[    ]  🔒        │           │
│  │   可收获    可收获    未解锁    未解锁      │           │
│  │                                             │           │
│  └─────────────────────────────────────────────┘           │
│                                                             │
│  [一键收获] [一键种植] [铲除未熟] [🤖傀儡:ON]               │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  灵植阁                                                    │
│  [凡阶] [1转] [2转] ... [9转]                              │
│                                                             │
│  ┌────────────────────────────────────────┐                │
│  │ 🌿 凝气草    10💎    +15💎   +5EXP   │                │
│  │ 🍒 血菩提   100💎   +250💎  +25EXP   │                │
│  │ ...                                    │                │
│  └────────────────────────────────────────┘                │
│                                                             │
│  ⛏️ 玉灵铲（铲除模式）                                     │
│                                                             │
│  🔥 丹火提炼: ON  (+20%收益)                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 与主游戏界面的整合

```javascript
// 方案1：独立标签页（推荐）
// 在右侧系统面板新增"百草灵园"标签
const TABS = ['law', 'dungeon', 'realm', 'garden', 'treasure'];

// 方案2：悬浮入口
// 在主界面显示一个小型灵植园状态图标
// 点击后展开完整界面

// 采用方案1，更直观
```

---

## 💰 商业化设计

### 付费点1：土地扩展包

```
免费土地：4块
付费解锁：
- 第5-8块：30元（4块打包）
- 第9-12块：68元
- 第13-16块：128元

策略：渐进式付费，小额多次
```

### 付费点2：傀儡高级托管

```
基础傀儡（免费）：
- 自动收获
- 自动补种（同类型）

高级傀儡（30元/月）：
- 自动选择当前最高收益作物
- 生长时间-20%
- 收益+10%
- 自动开垦新土地

至尊傀儡（68元/月）：
- 包含高级傀儡所有功能
- 离线期间也自动运行
- 每日赠送1000灵石
- 专属傀儡皮肤
```

### 付费点3：灵植变异

```
道具名称：灵植变异液
功能：使正在生长的灵植变异，收获时额外获得：
- 50%概率：收益×2
- 30%概率：收益×3
- 15%概率：收益×5
- 5%概率：收益×10

定价：6元/瓶，45元/10瓶

策略：类似抽卡的刺激感，但明码标价
```

### 付费点4：时间加速

```
道具名称：时光沙漏
功能：立即完成所有生长中灵植
定价：根据加速时间动态
- 加速<1小时：3元
- 加速1-4小时：10元
- 加速4-12小时：25元
- 加速>12小时：50元

策略：紧急情况使用，平时不建议购买
```

### 付费点5：灵植园赛季通行证

```
价格：68元/赛季（4周）

免费线：
- 灵石、基础种子

付费线：
- 限定皮肤（土地外观）
- 限定灵植（高经验作物）
- 大量灵石
- 傀儡升级材料
- 专属称号"神农再世"
```

---

## 🔧 技术实现

### 新增文件

```
js/
├── classes/
│   └── SpiritGarden.js      # 灵植园类
├── config/
│   └── garden-config.js     # 灵植配置
└── game/
    └── GardenSystem.js      # 灵植系统管理
```

### Game.js 集成

```javascript
class Game {
    constructor() {
        // ... existing code ...
        
        // 百草灵园系统
        this.garden = new SpiritGarden();
        this.gardenTimer = null;
    }
    
    init() {
        // ... existing init ...
        
        // 启动灵植园生长循环
        this.startGardenLoop();
    }
    
    startGardenLoop() {
        // 每100ms更新一次生长进度
        setInterval(() => {
            this.updateGardenGrowth();
        }, 100);
    }
    
    updateGardenGrowth() {
        const now = Date.now();
        
        this.garden.lands.forEach(land => {
            if (land.plant && land.progress < 100) {
                // 计算生长进度
                const elapsed = (now - land.plant.startTime) / 1000;
                const growTime = land.plant.time;
                
                // 应用傀儡加速
                let speedMult = 1;
                if (this.hasAdvancedPuppet) speedMult *= 1.2;
                
                land.progress = Math.min(100, (elapsed / growTime) * 100 * speedMult);
            }
        });
        
        // 傀儡自动收获和种植
        if (this.garden.puppetMode && this.garden.gardenLevel >= 2) {
            this.garden.lands.forEach(land => {
                // 自动收获
                if (land.plant && land.progress >= 100) {
                    this.harvestCrop(land);
                }
                // 自动种植
                if (land.unlocked && !land.plant && land.lastSeedId) {
                    this.plantCrop(land, land.lastSeedId);
                }
            });
        }
        
        this.updateGardenUI();
    }
    
    harvestCrop(land) {
        if (!land.plant) return;
        
        let income = land.plant.income;
        let exp = land.plant.exp;
        
        // 应用丹火加成
        if (this.garden.alchemyMode && this.garden.gardenLevel >= 10) {
            income = income.mul(1.2);
        }
        
        // 应用傀儡加成
        if (this.hasAdvancedPuppet) {
            income = income.mul(1.1);
        }
        
        // 获得灵石
        this.garden.spiritStones = this.garden.spiritStones.add(income);
        
        // 获得灵植园经验
        this.garden.gardenExp = this.garden.gardenExp.add(exp);
        
        // 转换为法则真意（如果已解锁）
        if (this.lawUnlocked) {
            const lawGain = exp.mul(0.1);  // 10%转换
            this.lawFragments = this.lawFragments.add(lawGain);
        }
        
        // 记录最后种植的种子
        land.lastSeedId = land.plant.id;
        
        // 清空土地
        land.plant = null;
        land.progress = 0;
        
        // 检查升级
        this.checkGardenLevelUp();
        
        this.log('GAIN', `收获${land.plant.name}，获得${formatNum(income)}灵石`);
    }
    
    plantCrop(land, seedId) {
        const seed = this.garden.getSeedById(seedId);
        if (!seed) return;
        
        if (this.garden.spiritStones.gte(seed.cost)) {
            this.garden.spiritStones = this.garden.spiritStones.sub(seed.cost);
            land.plant = {
                ...seed,
                startTime: Date.now()
            };
            return true;
        }
        return false;
    }
    
    checkGardenLevelUp() {
        const maxExp = this.garden.getMaxExp();
        
        while (this.garden.gardenExp.gte(maxExp)) {
            this.garden.gardenExp = this.garden.gardenExp.sub(maxExp);
            this.garden.gardenLevel++;
            
            // 检查转生
            const newTurn = Math.floor((this.garden.gardenLevel - 1) / 100);
            if (newTurn > this.garden.turn) {
                this.garden.turn = newTurn;
                this.garden.shopTurn = newTurn;
                this.log('GAIN', `灵植阁解锁[${TURN_NAMES[newTurn]}]种子！`);
            }
            
            this.log('GAIN', `灵植园等级提升至 Lv.${this.garden.gardenLevel}`);
        }
    }
    
    // 切换标签页时更新
    switchTab(tab) {
        // ... existing code ...
        if (tab === 'garden') {
            this.updateGardenUI();
        }
    }
    
    updateGardenUI() { /* 更新灵植园界面 */ }
}
```

### UI 结构

```html
<!-- 百草灵园标签页 -->
<div id="tab-garden" class="tab-content">
    <div class="system-section">
        <div class="res-display" style="border:none; color:#22c55e;">🌿 百草灵园</div>
        
        <!-- 等级和经验 -->
        <div class="garden-level">
            <span>Lv.<span id="garden-level">1</span></span>
            <span>(<span id="garden-turn">凡阶</span>)</span>
            <div class="exp-bar">
                <div id="garden-exp-bar" style="width: 0%"></div>
            </div>
        </div>
        
        <!-- 灵石显示 -->
        <div class="res-display">
            灵石: <span id="garden-stones">100</span>
        </div>
        
        <!-- 土地网格 -->
        <div class="land-grid" id="land-grid">
            <!-- 16块土地，由JS生成 -->
        </div>
        
        <!-- 操作按钮 -->
        <div class="garden-controls">
            <button class="sys-btn" onclick="game.gardenOneClickHarvest()">一键收获</button>
            <button class="sys-btn" onclick="game.gardenOneClickPlant()">一键种植</button>
            <button class="sys-btn btn-danger" onclick="game.gardenOneClickClear()">铲除未熟</button>
        </div>
        
        <!-- 傀儡模式 -->
        <div class="puppet-toggle" onclick="game.togglePuppetMode()">
            <span id="puppet-status">🤖 傀儡: OFF</span>
        </div>
    </div>
    
    <!-- 灵植阁 -->
    <div class="system-section" style="margin-top:10px;">
        <div class="res-display" style="border:none; color:#16a34a;">🏪 灵植阁</div>
        
        <!-- 转数选择 -->
        <div class="turn-selector" id="turn-selector">
            <button class="turn-btn active" data-turn="0">凡阶</button>
            <button class="turn-btn" data-turn="1">1转</button>
            <!-- ... -->
        </div>
        
        <!-- 种子列表 -->
        <div class="seed-list" id="seed-list">
            <!-- 由JS生成 -->
        </div>
        
        <!-- 工具 -->
        <div class="tool-section">
            <div class="tool-item" onclick="game.selectTool('shovel')">
                <span>⛏️ 玉灵铲</span>
                <span class="tool-desc">铲除植物</span>
            </div>
        </div>
        
        <!-- 丹火提炼 -->
        <div class="alchemy-toggle" id="alchemy-toggle" style="display:none;">
            <span>🔥 丹火提炼</span>
            <button onclick="game.toggleAlchemyMode()">OFF</button>
        </div>
    </div>
</div>
```

---

## 🎯 留存设计

### 每日循环
- 上线收取成熟灵植
- 补充种植
- 检查可解锁土地

### 每周目标
- 灵植园等级提升
- 解锁新转数作物
- 傀儡升级

### 长期追求
- 灵植园满级（1000级/10转）
- 所有土地解锁
- 收集所有70种灵植图鉴

---

## 📈 迭代扩展

### Phase 2：灵植融合
- 2株同种灵植可融合为变异种
- 变异种有更高收益和特殊效果

### Phase 3：灵植交易
- 玩家间可交易灵植
- 市场系统

### Phase 4：天灾系统
- 随机事件：虫害、干旱
- 需要应对策略

---

## ✅ 验收标准

- [ ] 土地开垦消耗正确计算
- [ ] 灵植生长进度正确更新
- [ ] 收获获得灵石和经验正确
- [ ] 灵植园升级和转生逻辑正确
- [ ] 傀儡自动收获和种植正常
- [ ] 丹火加成正确应用
- [ ] 与法则真意转换正常
- [ ] UI正确显示所有状态
