<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>åŠŸæ³•ç³»ç»Ÿæµ‹è¯•</title>
    <style>
        body {
            background: #1a1a2e;
            color: #eee;
            font-family: 'Microsoft YaHei', sans-serif;
            padding: 20px;
        }
        .test-result {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #4ade80;
        }
        .error {
            border-left-color: #ef4444;
        }
        .math {
            background: rgba(59, 130, 246, 0.1);
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        h1 { color: #fbbf24; }
        h2 { color: #4ade80; margin-top: 30px; }
        .highlight { color: #fbbf24; font-weight: bold; }
    </style>
</head>
<body>
    <h1>ğŸ§™â€â™‚ï¸ åŠŸæ³•ç³»ç»Ÿ (Gongfa System) æµ‹è¯•æŠ¥å‘Š</h1>
    <p>å®Œå…¨ä»¿ç…§ Clicker Heroes è‹±é›„ç³»ç»Ÿçš„ä¿®ä»™æ¢çš®å®ç°</p>

    <div id="results"></div>

    <!-- ä¾èµ– -->
    <script src="js/core/BigNum.js"></script>
    <script src="js/classes/GongfaSystem.js"></script>

    <script>
        const results = document.getElementById('results');

        function log(title, content, isError = false) {
            const div = document.createElement('div');
            div.className = 'test-result' + (isError ? ' error' : '');
            div.innerHTML = `<h3>${title}</h3><div>${content}</div>`;
            results.appendChild(div);
        }

        function mathLog(title, formula) {
            const div = document.createElement('div');
            div.className = 'math';
            div.innerHTML = `<strong>${title}</strong>\n${formula}`;
            results.appendChild(div);
        }

        // ========== æµ‹è¯•å¼€å§‹ ==========

        log('ğŸ® æµ‹è¯•å¼€å§‹', 'åˆ›å»ºåŠŸæ³•ç®¡ç†å™¨å’ŒåŸºç¡€åŠŸæ³•...');

        // åˆ›å»ºåŠŸæ³•ç®¡ç†å™¨
        const manager = new GongfaManager();

        // åˆ›å»ºåŸºç¡€åŠŸæ³• (ä»¿ç…§Clicker Heroesçš„ç¬¬ä¸€ä¸ªè‹±é›„Cid)
        const basicGongfa = manager.registerGongfa({
            id: 'basic_qi_gathering',
            name: 'åŸºç¡€åçº³æœ¯',
            description: 'æœ€åŸºç¡€çš„çµæ°”åçº³æ³•é—¨ï¼Œä¿®ç‚¼è€…é€šè¿‡å‘¼å¸åçº³å¸æ”¶å¤©åœ°çµæ°”',
            icon: 'ğŸŒ¬ï¸',
            baseCost: 10,           // åŸºç¡€æ¶ˆè€—10çµæ°” (ä»¿Cid)
            basePower: 1,           // åŸºç¡€æˆ˜åŠ›1
            costScale: 1.07,        // æ¯æ¬¡å‡çº§æˆæœ¬x1.07 (CHæ ‡å‡†)
            unlocked: true,
            secretArts: [
                { name: 'åçº³ç²¾é€š', unlockLayer: 10, type: 'self', multiplier: 2, description: 'åçº³æ•ˆç‡ç¿»å€' },
                { name: 'çµæ°”å…±é¸£', unlockLayer: 25, type: 'global', multiplier: 1.25, description: 'å…¨åŠŸæ³•æˆ˜åŠ›+25%' },
                { name: 'å‘¨å¤©è¿è½¬', unlockLayer: 50, type: 'self', multiplier: 2, description: 'å‘¨å¤©è¿è½¬ï¼Œæ•ˆç‡ç¿»å€' },
                { name: 'å¤©åœ°åˆä¸€', unlockLayer: 100, type: 'global', multiplier: 1.5, description: 'å…¨åŠŸæ³•æˆ˜åŠ›+50%' },
                { name: 'ä¸‡æ³•å½’å®—', unlockLayer: 125, type: 'self', multiplier: 2, description: 'ä¸‡æ³•å½’å®—ï¼Œæˆ˜åŠ›ç¿»å€' }
            ]
        });

        // æ˜¾ç¤ºåˆå§‹çŠ¶æ€
        log('ğŸ“Š åˆå§‹çŠ¶æ€', `
            åŠŸæ³•åç§°: ${basicGongfa.name}<br>
            å½“å‰å±‚æ•°: <span class="highlight">${basicGongfa.layer}</span><br>
            å½“å‰æˆ˜åŠ›: ${basicGongfa.getPower().toString()}<br>
            ä¸‹ä¸€å±‚æ¶ˆè€—: ${basicGongfa.getNextLayerCost().toString()}
        `);

        // ========== æµ‹è¯•1: æ•°å­¦å…¬å¼éªŒè¯ ==========

        mathLog('ğŸ“ ç­‰æ¯”æ•°åˆ—æ±‚å’Œå…¬å¼ (Cost Calculation)',
`æ¯å±‚æ¶ˆè€—: Cost_n = BaseCost Ã— (1.07)^n

ä»0å±‚å‡åˆ°Lå±‚çš„æ€»æ¶ˆè€— (ç­‰æ¯”æ•°åˆ—æ±‚å’Œ):
Total = BaseCost Ã— [(1.07)^0 + (1.07)^1 + ... + (1.07)^(L-1)]

ç­‰æ¯”æ•°åˆ—å…¬å¼: S_n = a_1 Ã— (r^n - 1) / (r - 1)
å…¶ä¸­: a_1 = 1, r = 1.07, n = L

å› æ­¤: Total = BaseCost Ã— [(1.07)^L - 1] / 0.07`);

        mathLog('ğŸ“ BuyMax åæ¨å…¬å¼ (Reverse Calculation)',
`è®¾å½“å‰å±‚æ•° L0, æ‹¥æœ‰çµæ°” R, æ±‚å¯å‡åˆ°ç¬¬ L å±‚

æ€»æ¶ˆè€—å…¬å¼:
Cost = BaseCost Ã— (1.07)^L0 Ã— [(1.07)^(L-L0) - 1] / 0.07

ä»¤ x = (1.07)^(L-L0), åˆ™:
R = BaseCost Ã— (1.07)^L0 Ã— (x - 1) / 0.07

è§£å¾—:
x = 1 + R Ã— 0.07 / (BaseCost Ã— (1.07)^L0)

å–å¯¹æ•°:
L - L0 = log(x) / log(1.07)
L = L0 + log(1 + R Ã— 0.07 / (BaseCost Ã— (1.07)^L0)) / log(1.07)`);

        // ========== æµ‹è¯•2: å°é¢å‡çº§æµ‹è¯• ==========

        log('ğŸ’° æµ‹è¯•1: å°é¢å‡çº§ (é€å±‚å‡çº§)', 'ä»0å±‚å¼€å§‹ï¼Œå°è¯•å‡åˆ°10å±‚...');

        // è®¡ç®—å‡åˆ°10å±‚éœ€è¦çš„çµæ°”
        const costTo10 = basicGongfa.calculateCostToLayer(10);
        log('ğŸ’¡ è®¡ç®—ç»“æœ', `
            å‡åˆ°10å±‚æ€»æ¶ˆè€—: ${costTo10.toString()}<br>
            å…¬å¼éªŒè¯: 10 Ã— [(1.07)^10 - 1] / 0.07 = ${(10 * (Math.pow(1.07, 10) - 1) / 0.07).toFixed(2)}
        `);

        // æ‰§è¡Œå‡çº§
        const reiki1 = new BigNum(1, 3); // 1000çµæ°” (è¶³å¤Ÿå‡åˆ°10å±‚)
        const result1 = basicGongfa.buyMax(reiki1);

        log('âœ… å‡çº§ç»“æœ', `
            æˆåŠŸ: ${result1.success}<br>
            å‡çº§å±‚æ•°: <span class="highlight">${result1.layers}</span><br>
            æœ€ç»ˆå±‚æ•°: <span class="highlight">${result1.newLayer}</span><br>
            æ¶ˆè€—çµæ°”: ${result1.spent.toString()}<br>
            å‰©ä½™çµæ°”: ${reiki1.sub(result1.spent).toString()}
        `);

        // éªŒè¯çªç ´å€ç‡
        const btMult = basicGongfa.getBreakthroughMultiplier();
        log('âš¡ çªç ´å€ç‡', `
            å½“å‰å±‚æ•°: ${basicGongfa.layer}<br>
            çªç ´å€ç‡: <span class="highlight">Ã—${btMult}</span><br>
            (10å±‚ Ã—4)<br>
            å½“å‰æˆ˜åŠ›: ${basicGongfa.getPower().toString()}
        `);

        // ========== æµ‹è¯•3: å¤§é¢BuyMaxæµ‹è¯• ==========

        log('ğŸ’ æµ‹è¯•2: å¤§é¢BuyMax (1e100çµæ°”)', 'æ¨¡æ‹Ÿç©å®¶æ‹¥æœ‰1e100çµæ°”ï¼Œæ‰§è¡ŒbuyMax...');

        // é‡ç½®åŠŸæ³•
        basicGongfa.layer = 0;
        basicGongfa.totalSpent = new BigNum(0);

        const reiki2 = new BigNum(1, 100); // 1e100
        const startTime = performance.now();
        const result2 = basicGongfa.buyMax(reiki2);
        const endTime = performance.now();

        // ç†è®ºè®¡ç®—éªŒè¯
        const L0 = 0;
        const r = reiki2.toNumber();
        const theoreticalMax = Math.log(1 + r * 0.07 / 10) / Math.log(1.07);

        log('âœ… BuyMax ç»“æœ', `
            æ‰§è¡Œæ—¶é—´: <span class="highlight">${(endTime - startTime).toFixed(3)}ms</span> (æ— å¾ªç¯!)<br>
            å‡çº§å±‚æ•°: <span class="highlight">${result2.layers}</span><br>
            æœ€ç»ˆå±‚æ•°: <span class="highlight">${result2.newLayer}</span><br>
            æ¶ˆè€—çµæ°”: ${result2.spent.toString()}<br>
            ç†è®ºæœ€å¤§å±‚æ•°: ${Math.floor(theoreticalMax)}<br>
            è¯¯å·®: ${Math.abs(theoreticalMax - result2.newLayer).toFixed(6)}å±‚
        `);

        // ========== æµ‹è¯•4: çªç ´å€ç‡ç³»ç»Ÿ ==========

        log('ğŸ¯ æµ‹è¯•3: çªç ´å€ç‡ç³»ç»Ÿ (Milestone Multipliers)',
            'æµ‹è¯•ä¸åŒå±‚æ•°çš„çªç ´å€ç‡...');

        const testLayers = [10, 25, 50, 75, 100, 125, 150, 200, 500, 1000, 1025];
        let breakthroughInfo = '';

        for (const layer of testLayers) {
            // ä¸´æ—¶è®¾ç½®å±‚æ•°è®¡ç®—å€ç‡
            const originalLayer = basicGongfa.layer;
            basicGongfa.layer = layer;
            const mult = basicGongfa.getBreakthroughMultiplier();

            let explanation = '';
            if (layer >= 1000) explanation = '(1000å±‚Ã—10)';
            else if (layer >= 200) explanation = '(200å±‚Ã—10 + ä¹‹å‰å€æ•°)';
            else if (layer >= 100) explanation = '(100å±‚Ã—10)';
            else if (layer >= 75) explanation = '(75å±‚Ã—4)';
            else if (layer >= 50) explanation = '(50å±‚Ã—4)';
            else if (layer >= 25) explanation = '(25å±‚Ã—4)';
            else if (layer >= 10) explanation = '(10å±‚Ã—4)';

            breakthroughInfo += `å±‚æ•° ${layer}: <span class="highlight">Ã—${mult}</span> ${explanation}<br>`;
            basicGongfa.layer = originalLayer;
        }

        log('ğŸ“ˆ çªç ´å€ç‡è¡¨', breakthroughInfo);

        // ========== æµ‹è¯•5: ç§˜æœ¯ç³»ç»Ÿ ==========

        log('ğŸ“œ æµ‹è¯•4: ç§˜æœ¯ç³»ç»Ÿ (Secret Arts)', 'æ£€æŸ¥å¯è§£é”çš„ç§˜æœ¯...');

        // è®¾ç½®åˆ°125å±‚ä»¥è§£é”æ‰€æœ‰ç§˜æœ¯
        basicGongfa.layer = 125;
        const availableArts = basicGongfa.getAvailableSecretArts();

        let artsInfo = '';
        for (const art of availableArts) {
            artsInfo += `
                <strong>${art.name}</strong> (${art.unlockLayer}å±‚è§£é”)<br>
                æ•ˆæœ: ${art.getEffectDesc()}<br>
                æ¶ˆè€—: ${art.cost.toString()} çµæ°”<br><br>
            `;
        }

        log('ğŸ”® å¯è´­ä¹°ç§˜æœ¯', artsInfo || 'æš‚æ— å¯è´­ä¹°ç§˜æœ¯');

        // ========== æµ‹è¯•6: å¤šåŠŸæ³•ç®¡ç†å™¨æµ‹è¯• ==========

        log('ğŸ›ï¸ æµ‹è¯•5: åŠŸæ³•ç®¡ç†å™¨', 'æ³¨å†Œå¤šä¸ªåŠŸæ³•ï¼Œæµ‹è¯•æ€»æˆ˜åŠ›è®¡ç®—...');

        // æ³¨å†Œæ›´å¤šåŠŸæ³•
        const advancedGongfa = manager.registerGongfa({
            id: 'advanced_qi_cultivation',
            name: 'é«˜çº§ç»ƒæ°”è¯€',
            description: 'æ›´é«˜çº§çš„ç»ƒæ°”æ³•é—¨',
            icon: 'ğŸ”¥',
            baseCost: 100,
            basePower: 5,
            costScale: 1.07,
            unlocked: false,
            unlockCost: new BigNum(1, 5), // 1e5è§£é”
            secretArts: [
                { name: 'ç‚‰ç«çº¯é’', unlockLayer: 10, type: 'self', multiplier: 2 },
                { name: 'æ°”è´¯é•¿è™¹', unlockLayer: 50, type: 'global', multiplier: 1.5 }
            ]
        });

        // è§£é”å¹¶å‡çº§
        manager.unlockGongfa('advanced_qi_cultivation', new BigNum(1, 10));
        advancedGongfa.buyMax(new BigNum(1, 50)); // 1e50çµæ°”å‡çº§

        const totalPower = manager.getTotalPower();
        const globalMult = manager.getGlobalMultiplier();

        log('âš”ï¸ æ€»æˆ˜åŠ›ç»Ÿè®¡', `
            å·²è§£é”åŠŸæ³•æ•°: ${manager.unlockedCount}<br>
            å…¨å±€å€ç‡: <span class="highlight">Ã—${globalMult}</span><br>
            æ€»æˆ˜åŠ›: <span class="highlight">${totalPower.toString()}</span>
        `);

        // ========== æ€»ç»“ ==========

        log('âœ¨ æµ‹è¯•æ€»ç»“', `
            <strong>æ ¸å¿ƒç‰¹æ€§éªŒè¯:</strong><br>
            âœ… ç­‰æ¯”æ•°åˆ—æ±‚å’Œå…¬å¼è®¡ç®—å‡çº§æˆæœ¬ (æ— å¾ªç¯)<br>
            âœ… BuyMax ä½¿ç”¨å¯¹æ•°åæ¨æœ€å¤§å¯å‡å±‚æ•° (O(1)å¤æ‚åº¦)<br>
            âœ… çªç ´å€ç‡ç³»ç»Ÿ: 10/25/50/75å±‚Ã—4, 100å±‚Ã—10, æ¯25å±‚Ã—4, æ¯1000å±‚Ã—10<br>
            âœ… ç§˜æœ¯ç³»ç»Ÿ: ç‰¹å®šå±‚æ•°è§£é”, self/globalä¸¤ç§ç±»å‹<br>
            âœ… æ¢çš®æ˜ å°„: Heroâ†’åŠŸæ³•, Levelâ†’å±‚æ•°, DPSâ†’æˆ˜åŠ›, Goldâ†’çµæ°”<br><br>

            <strong>æ€§èƒ½è¡¨ç°:</strong><br>
            BuyMax(1e100çµæ°”) æ‰§è¡Œæ—¶é—´: ${(endTime - startTime).toFixed(3)}ms<br>
            å‡çº§å±‚æ•°: ${result2.newLayer}å±‚<br>
            ç†è®ºéªŒè¯: è¯¯å·® ${Math.abs(theoreticalMax - result2.newLayer).toFixed(6)}å±‚
        `);

        console.log('=== æµ‹è¯•ç»“æœå·²è¾“å‡ºåˆ°é¡µé¢ ===');
        console.log('åŠŸæ³•ç®¡ç†å™¨:', manager);
        console.log('åŸºç¡€åŠŸæ³•:', basicGongfa);
    </script>
</body>
</html>
