<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>指数修仙：丹药无双 (副本秘宝版)</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

<header>
    <h1>指数修仙：丹药无双 (副本秘宝版)</h1>
    <div class="header-controls">
        <div class="difficulty-badge" id="level-display">荒野层数: 0 (凡人)</div>
        <button class="cheat-btn" onclick="game.toggleCheatModal()">🔥 金手指</button>
    </div>
</header>

<div id="game-container">
    <!-- Left Panel: Stats & Equipment -->
    <div class="panel">
        <div class="panel-title">修士属性</div>
        <div class="stat-row"><span>生命值:</span> <span id="stat-hp" class="val">300 / 300</span></div>
        <div class="stat-row"><span>攻击力:</span> <span id="stat-atk" class="val">50</span></div>
        <div class="stat-row"><span>暴击率:</span> <span id="stat-crit" class="val">0%</span></div>
        
        <div class="panel-title" style="margin-top:10px;">加成统计</div>
        <div class="stat-row"><span>境界加成:</span> <span id="mul-realm" class="val">x1.00</span></div>
        <div class="stat-row"><span>法则倍率:</span> <span id="mul-atk" class="val">100%</span> (攻/血)</div>
        <div class="stat-row"><span>通天塔掉率:</span> <span id="mul-drop" class="val">0%</span></div>
        <div class="stat-row"><span>秘宝加成:</span> <span id="bonus-treasure" class="val" style="font-size:0.8rem">无</span></div>

        <div class="panel-title" style="margin-top:10px;">装备 (自动替换)</div>
        <div class="equip-grid" id="equip-grid">
            <!-- Generated by JS -->
        </div>
    </div>

    <!-- Center Panel: Combat -->
    <div class="panel" style="position: relative;">
        <div class="panel-title" id="stage-name">荒野 - 第 0 层</div>
        
        <div class="combat-scene">
            <div id="damage-overlay" style="position:absolute; width:100%; height:100%; pointer-events:none;"></div>
            <div id="skill-overlay" style="position:absolute; width:100%; height:100%; pointer-events:none;"></div>
            
            <div id="resurrect-overlay" class="resurrect-overlay">
                <div id="resurrect-text">已死亡<br><span style="font-size:1rem; color:#fff;">2秒后复活...</span></div>
            </div>

            <!-- Enemy Grid Container -->
            <div class="enemy-container" id="enemy-container">
                <!-- Enemies injected here -->
            </div>
            
            <div style="height: 30px; text-align: center; color: #555; font-size: 0.8rem; display: flex; align-items: center;">
                VS
            </div>

            <!-- Player -->
            <div class="entity player-entity" id="player-entity">
                <span>🧘</span>
                <div class="hp-bar-container">
                    <div class="hp-bar-fill" id="player-hp-bar" style="width: 100%;"></div>
                </div>
            </div>
        </div>

        <div class="controls">
            <!-- Modified Button -->
            <button class="btn-boss" id="btn-challenge" 
                onclick="game.manualSummonBoss()" 
                oncontextmenu="event.preventDefault(); game.toggleAutoBoss()">
                💀 召唤荒野BOSS (右键自动)
            </button>
        </div>
        
        <div id="battle-log"></div>
    </div>

    <!-- Right Panel: Game Systems -->
    <div class="panel">
        <div class="panel-title">游戏系统</div>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="game.switchTab('law')">☯️ 法则悟道</button>
            <button class="tab-btn" onclick="game.switchTab('dungeon')">🔥 副本探险</button>
            <button class="tab-btn" onclick="game.switchTab('realm')">✨ 境界突破</button>
        </div>

        <!-- Law Cultivation Tab (法则悟道 - 合并法则修炼+通天塔) -->
        <div id="tab-law" class="tab-content active">
            <!-- 上部：法则修炼 -->
            <div class="system-section">
                <div class="res-display" style="border:none; color:#00bcd4;">📿 法则修炼</div>
                <div class="res-display">法则真意: <span id="res-law">0</span></div>
                <div class="sub-stat">当前轮次: <span id="cult-round" class="val">0</span></div>
                <div class="sub-stat">修炼进度: <span id="cult-step" class="val">0 / 10</span></div>
                <div class="sub-stat">下次加成: <span id="cult-next" class="highlight">攻击 +10%</span></div>
                <div class="sub-stat">单次消耗: <span id="cult-cost">2</span></div>
                <div style="display:flex; gap:5px; margin-top:10px;">
                    <button class="sys-btn btn-cultivate" onclick="game.cultivate()">✨ 感悟法则</button>
                    <button class="sys-btn btn-cultivate-all" onclick="game.cultivateAll()">⚡ 一键感悟</button>
                </div>
            </div>
            
            <!-- 下部：通天塔 -->
            <div class="system-section" style="margin-top:10px;">
                <div class="res-display" style="border:none; color:#3f51b5;">🗼 通天塔</div>
                <div class="sub-stat">当前层数: <span id="tower-lv" class="val">0</span></div>
                <div class="sub-stat">怪物强度: <span class="highlight">10^层数</span> (极难)</div>
                <div class="sub-stat">掉落真意: <span id="tower-drop">1</span></div>
                <button class="sys-btn btn-tower" id="btn-tower-toggle" onclick="game.toggleTowerMode()">🗼 挑战通天塔</button>
                <div style="font-size:0.7rem; color:#888; margin-top:5px;">
                    * 挑战通天塔可获得法则真意<br>
                    * 每10层法则掉率翻倍
                </div>
            </div>
        </div>

        <!-- Dungeon & Treasure Tab (副本探险 - 合并副本+秘宝) -->
        <div id="tab-dungeon" class="tab-content">
            <!-- 上部：副本挑战 -->
            <div class="system-section">
                <div class="res-display" style="border:none; color:#e65100;">🔥 血色副本</div>
                <div class="sub-stat">当前层数: <span id="dungeon-tier" class="val">T1</span></div>
                <div class="sub-stat">副本难度: <span id="dungeon-lv" class="val">1</span></div>
                <div class="sub-stat">当前进度: <span id="dungeon-status">未开启</span></div>
                <div class="sub-stat">自动倒计时: <span id="dungeon-timer">--</span></div>
                
                <!-- 层数选择 -->
                <div style="margin: 10px 0; padding: 8px; background: #1a1a1a; border-radius: 5px;">
                    <div style="font-size: 0.75rem; color: #888; margin-bottom: 5px;">选择层数 (点击切换):</div>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        <button id="dungeon-tier-1" class="tier-btn" onclick="game.dungeon.setTier(1)" style="flex: 1; padding: 5px; background: #e65100; border: none; color: white; border-radius: 3px; cursor: pointer;">T1</button>
                        <button id="dungeon-tier-2" class="tier-btn" onclick="game.dungeon.setTier(2)" style="flex: 1; padding: 5px; background: #333; border: none; color: #666; border-radius: 3px; cursor: not-allowed;" disabled>T2🔒</button>
                        <button id="dungeon-tier-3" class="tier-btn" onclick="game.dungeon.setTier(3)" style="flex: 1; padding: 5px; background: #333; border: none; color: #666; border-radius: 3px; cursor: not-allowed;" disabled>T3🔒</button>
                        <button id="dungeon-tier-4" class="tier-btn" onclick="game.dungeon.setTier(4)" style="flex: 1; padding: 5px; background: #333; border: none; color: #666; border-radius: 3px; cursor: not-allowed;" disabled>T4🔒</button>
                        <button id="dungeon-tier-5" class="tier-btn" onclick="game.dungeon.setTier(5)" style="flex: 1; padding: 5px; background: #333; border: none; color: #666; border-radius: 3px; cursor: not-allowed;" disabled>T5🔒</button>
                    </div>
                    <div id="dungeon-unlock-hint" style="font-size: 0.7rem; color: #ff9800; margin-top: 5px;"></div>
                </div>
                
                <button class="sys-btn btn-dungeon" id="btn-dungeon-toggle" onclick="game.toggleDungeonMode()">🔥 进入副本</button>
                <div style="font-size:0.7rem; color:#888; margin-top:5px;">
                    * 伤害数值压缩: (log伤害)^2。<br>
                    * 通关获得秘宝宝箱与碎片。
                </div>
            </div>
            
            <!-- 下部：秘宝系统 -->
            <div class="system-section" style="margin-top:10px;">
                <div class="res-display" style="border:none; color:#7b1fa2;">🏺 秘宝阁</div>
                <div class="sub-stat">待开宝箱: <span id="chest-count" class="highlight">0</span></div>
                <div class="sub-stat">剩余次数: <span id="treasure-daily">20 / 20</span></div>
                <div class="sub-stat">秘宝碎片: <span id="treasure-frags">0</span></div>
                <button class="sys-btn btn-treasure" onclick="game.openTreasureModal()">🚪 进入秘宝阁</button>
                <div style="font-size:0.7rem; color:#888; margin-top:5px;">
                    * 通关副本获得宝箱<br>
                    * 每日20次开启限制
                </div>
            </div>
        </div>

        <!-- Realm Breakthrough Tab (境界突破 - 独立标签) -->
        <div id="tab-realm" class="tab-content">
            <div class="system-section">
                <div class="res-display" style="border:none; color:#ffd700;">✨ 境界突破</div>
                <div class="sub-stat">当前境界: <span id="realm-name" class="val highlight">凡人-武者</span></div>
                <div class="sub-stat">境界加成: <span id="realm-bonus" class="val">x1.00</span> (全属性)</div>
                <div class="sub-stat">下一境界: <span id="next-realm" class="val">练气-初期</span></div>
                <div class="sub-stat">突破需求: 历史最高难度达到 <span id="realm-req" class="val highlight">N4</span></div>
                <div class="sub-stat">当前进度: <span id="realm-progress" class="val">1/4 (25%)</span></div>
                
                <button class="sys-btn btn-realm" id="btn-realm-challenge" onclick="game.summonRealmBoss()" disabled>🔒 难度不足</button>
                <div style="font-size:0.7rem; color:#888; margin-top:5px;">
                    * 达到指定难度后可挑战境界天劫<br>
                    * 击败天劫BOSS即可突破境界<br>
                    * 突破后获得全属性加成
                </div>
            </div>
        </div>
    </div>
</div>

<div id="tooltip"></div>

<!-- Item Modal -->
<div id="item-modal" class="game-modal" style="z-index: 2000;">
    <div class="modal-content">
        <h3 id="modal-title" style="margin-top:0;">Item Name</h3>
        <p id="modal-desc" style="color:#aaa; font-size:0.9rem;">Stats</p>
        <div id="modal-actions">
            <!-- Buttons injected by JS -->
        </div>
        <button class="modal-btn btn-close" onclick="game.closeModal('item-modal')">关闭</button>
    </div>
</div>

<!-- Treasure Full Screen Modal -->
<div id="treasure-full-modal" class="game-modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #444; padding-bottom:10px;">
            <h2 style="margin:0; color:#7b1fa2;">秘宝阁</h2>
            <button class="modal-btn btn-close" style="width:auto; margin:0;" onclick="game.closeModal('treasure-full-modal')">✕</button>
        </div>
        
        <div class="treasure-layout">
            <!-- Left: Equipped -->
            <div class="treasure-left-panel">
                <div style="font-weight:bold; margin-bottom:10px; color:#aaa;">已装备秘宝 (右键卸下)</div>
                <div class="equip-grid" id="treasure-equip-grid" style="grid-template-columns: repeat(2, 1fr); gap: 8px;">
                    <!-- Slots -->
                </div>
                
                <div style="margin-top:auto; font-size:0.8rem; color:#888;">
                    <div class="sub-stat">待开宝箱: <span id="modal-chest-count" class="highlight">0</span></div>
                    <div class="sub-stat">剩余次数: <span id="modal-daily-count">20</span></div>
                    <div class="sub-stat">秘宝碎片: <span id="modal-frag-count">0</span></div>
                </div>
            </div>

            <!-- Right: Bag & Controls -->
            <div class="treasure-right-panel">
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <button class="sys-btn btn-treasure" style="flex:1; margin:0;" onclick="game.openTreasureBox(1)">🎁 开启宝箱 (消耗1次)</button>
                    <button class="sys-btn btn-treasure" style="flex:1; margin:0;" onclick="game.exchangeTreasure()">♻️ 碎片兑换</button>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <span style="font-weight:bold; color:#aaa;">秘宝背包 (右键穿戴/替换)</span>
                    <button onclick="game.autoDecompose()" style="font-size:0.8rem; padding:4px 8px; background:#f44336; border:none; color:white; cursor:pointer;">一键分解</button>
                </div>
                
                <div class="treasure-bag-grid" id="treasure-bag">
                    <!-- Bag Items -->
                </div>

                <div style="margin-top:10px; border-top:1px solid #444; padding-top:10px; display:flex; gap:5px;">
                    <input type="text" id="redeem-code-modal" placeholder="输入兑换码" style="flex:1; padding:5px; background:#111; border:1px solid #444; color:#fff;">
                    <button onclick="game.redeemCode('modal')" style="padding:5px 15px;">兑换</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cheat Modal -->
<div id="cheat-modal" class="game-modal">
    <div class="modal-content">
        <h3 style="margin-top:0; color:#ff1744;">🔥 金手指修改器</h3>
        <select id="cheat-type" class="cheat-select">
            <option value="atk">增加基础攻击力</option>
            <option value="hp">增加基础生命值</option>
            <option value="curHp">恢复当前生命值</option>
            <option value="law">增加法则真意</option>
            <option value="chest">增加秘宝宝箱</option>
            <option value="frag">增加秘宝碎片</option>
            <option value="ticket">增加秘宝次数</option>
            <option value="realm">增加境界等级</option>
            <option value="diff">增加历史最高难度</option>
        </select>
        <input type="text" id="cheat-val" class="cheat-input" placeholder="输入数值 (支持 1e100)">
        <div style="font-size:0.8rem; color:#888;">支持极大数值，输入过大将变为∞</div>
        <button class="modal-btn btn-use" onclick="game.applyCheat()">确认修改</button>
        <button class="modal-btn btn-close" onclick="game.closeModal('cheat-modal')">关闭</button>
    </div>
</div>

<!-- Core Scripts -->
<script src="js/core/BigNum.js"></script>
<script src="js/config.js"></script>
<script src="js/utils.js"></script>
<script src="js/classes/Item.js"></script>
<script src="js/classes/Treasure.js"></script>
<script src="js/classes/Dungeon.js"></script>
<script src="js/game/Game.js"></script>

<!-- Initialize Game -->
<script>
const game = new Game();
</script>

</body>
</html>
