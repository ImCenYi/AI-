<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>指数修仙：丹药无双 (副本秘宝版)</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

<header>
    <h1>指数修仙：丹药无双 (副本秘宝版)</h1>
    <div class="header-controls">
        <div class="difficulty-badge" id="level-display">荒野层数: 0 (凡人)</div>
        <button class="cheat-btn" onclick="game.toggleCheatModal()">🔥 金手指</button>
    </div>
</header>

<div id="game-container">
    <!-- Left Panel: Stats & Equipment -->
    <div class="panel">
        <div class="panel-title">修士属性</div>
        <div class="stat-row"><span>生命值:</span> <span id="stat-hp" class="val">300 / 300</span></div>
        <div class="stat-row"><span>攻击力:</span> <span id="stat-atk" class="val">50</span></div>
        <div class="stat-row"><span>暴击率:</span> <span id="stat-crit" class="val">0%</span></div>
        
        <div class="panel-title" style="margin-top:10px;">加成统计</div>
        <div class="stat-row"><span>境界加成:</span> <span id="mul-realm" class="val">x1.00</span></div>
        <div class="stat-row"><span>法则倍率:</span> <span id="mul-atk" class="val">100%</span> (攻/血)</div>
        <div class="stat-row"><span>通天塔掉率:</span> <span id="mul-drop" class="val">0%</span></div>
        <div class="stat-row"><span>秘宝加成:</span> <span id="bonus-treasure" class="val" style="font-size:0.8rem">无</span></div>

        <div class="panel-title" style="margin-top:10px;">装备 (自动替换)</div>
        <div class="equip-grid" id="equip-grid">
            <!-- Generated by JS -->
        </div>
    </div>

    <!-- Center Panel: Combat -->
    <div class="panel" style="position: relative;">
        <div class="panel-title" id="stage-name">荒野 - 第 0 层</div>
        
        <div class="combat-scene">
            <div id="damage-overlay" style="position:absolute; width:100%; height:100%; pointer-events:none;"></div>
            <div id="skill-overlay" style="position:absolute; width:100%; height:100%; pointer-events:none;"></div>
            
            <div id="resurrect-overlay" class="resurrect-overlay">
                <div id="resurrect-text">已死亡<br><span style="font-size:1rem; color:#fff;">2秒后复活...</span></div>
            </div>

            <!-- Enemy Grid Container -->
            <div class="enemy-container" id="enemy-container">
                <!-- Enemies injected here -->
            </div>
            
            <div style="height: 30px; text-align: center; color: #555; font-size: 0.8rem; display: flex; align-items: center;">
                VS
            </div>

            <!-- Player -->
            <div class="entity player-entity" id="player-entity">
                <span>🧘</span>
                <div class="hp-bar-container">
                    <div class="hp-bar-fill" id="player-hp-bar" style="width: 100%;"></div>
                </div>
            </div>
        </div>

        <div class="controls">
            <!-- Modified Button -->
            <button class="btn-boss" id="btn-challenge" 
                onclick="game.manualSummonBoss()" 
                oncontextmenu="event.preventDefault(); game.toggleAutoBoss()">
                💀 召唤荒野BOSS (右键自动)
            </button>
        </div>
        
        <div id="battle-log"></div>
    </div>

    <!-- Right Panel: Game Systems -->
    <div class="panel">
        <div class="panel-title">游戏系统</div>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="game.switchTab('law')">☯️ 法则悟道</button>
            <button class="tab-btn" onclick="game.switchTab('dungeon')">🔥 副本探险</button>
            <button class="tab-btn" onclick="game.switchTab('realm')">✨ 境界突破</button>
            <button class="tab-btn" onclick="game.switchTab('garden')">🌿 百草灵园</button>
        </div>

        <!-- Law Cultivation Tab (法则悟道 - 合并法则修炼+通天塔) -->
        <div id="tab-law" class="tab-content active">
            <!-- 上部：法则修炼 -->
            <div class="system-section">
                <div class="res-display" style="border:none; color:#00bcd4;">📿 法则修炼</div>
                <div class="res-display">法则真意: <span id="res-law">0</span></div>
                <div class="sub-stat">当前轮次: <span id="cult-round" class="val">0</span></div>
                <div class="sub-stat">修炼进度: <span id="cult-step" class="val">0 / 10</span></div>
                <div class="sub-stat">下次加成: <span id="cult-next" class="highlight">攻击 +10%</span></div>
                <div class="sub-stat">单次消耗: <span id="cult-cost">2</span></div>
                <div style="display:flex; gap:5px; margin-top:10px;">
                    <button class="sys-btn btn-cultivate" onclick="game.cultivate()">✨ 感悟法则</button>
                    <button class="sys-btn btn-cultivate-all" onclick="game.cultivateAll()">⚡ 一键感悟</button>
                </div>
            </div>
            
            <!-- 下部：通天塔 -->
            <div class="system-section" style="margin-top:10px;">
                <div class="res-display" style="border:none; color:#3f51b5;">🗼 通天塔</div>
                <div class="sub-stat">当前层数: <span id="tower-lv" class="val">0</span></div>
                <div class="sub-stat">怪物强度: <span class="highlight">10^层数</span> (极难)</div>
                <div class="sub-stat">掉落真意: <span id="tower-drop">1</span></div>
                <button class="sys-btn btn-tower" id="btn-tower-toggle" onclick="game.toggleTowerMode()">🗼 挑战通天塔</button>
                <div style="font-size:0.7rem; color:#888; margin-top:5px;">
                    * 挑战通天塔可获得法则真意<br>
                    * 每10层法则掉率翻倍
                </div>
            </div>
        </div>

        <!-- Dungeon & Treasure Tab (副本探险 - 合并副本+秘宝) -->
        <div id="tab-dungeon" class="tab-content">
            <!-- 上部：副本挑战 -->
            <div class="system-section">
                <div class="res-display" style="border:none; color:#e65100;">🔥 血色副本</div>
                <div class="sub-stat">当前层数: <span id="dungeon-tier" class="val">T1</span></div>
                <div class="sub-stat">副本难度: <span id="dungeon-lv" class="val">1</span></div>
                <div class="sub-stat">当前进度: <span id="dungeon-status">未开启</span></div>
                <div class="sub-stat">自动倒计时: <span id="dungeon-timer">--</span></div>
                
                <!-- 层数选择 -->
                <div style="margin: 10px 0; padding: 8px; background: #1a1a1a; border-radius: 5px;">
                    <div style="font-size: 0.75rem; color: #888; margin-bottom: 5px;">选择层数 (点击切换):</div>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        <button id="dungeon-tier-1" class="tier-btn" onclick="game.dungeon.setTier(1)" style="flex: 1; padding: 5px; background: #e65100; border: none; color: white; border-radius: 3px; cursor: pointer;">T1</button>
                        <button id="dungeon-tier-2" class="tier-btn" onclick="game.dungeon.setTier(2)" style="flex: 1; padding: 5px; background: #333; border: none; color: #666; border-radius: 3px; cursor: not-allowed;" disabled>T2🔒</button>
                        <button id="dungeon-tier-3" class="tier-btn" onclick="game.dungeon.setTier(3)" style="flex: 1; padding: 5px; background: #333; border: none; color: #666; border-radius: 3px; cursor: not-allowed;" disabled>T3🔒</button>
                        <button id="dungeon-tier-4" class="tier-btn" onclick="game.dungeon.setTier(4)" style="flex: 1; padding: 5px; background: #333; border: none; color: #666; border-radius: 3px; cursor: not-allowed;" disabled>T4🔒</button>
                        <button id="dungeon-tier-5" class="tier-btn" onclick="game.dungeon.setTier(5)" style="flex: 1; padding: 5px; background: #333; border: none; color: #666; border-radius: 3px; cursor: not-allowed;" disabled>T5🔒</button>
                    </div>
                    <div id="dungeon-unlock-hint" style="font-size: 0.7rem; color: #ff9800; margin-top: 5px;"></div>
                </div>
                
                <button class="sys-btn btn-dungeon" id="btn-dungeon-toggle" onclick="game.toggleDungeonMode()">🔥 进入副本</button>
                <div style="font-size:0.7rem; color:#888; margin-top:5px;">
                    * 伤害数值压缩: (log伤害)^2。<br>
                    * 通关获得秘宝宝箱与碎片。
                </div>
            </div>
            
            <!-- 下部：秘宝系统 -->
            <div class="system-section" style="margin-top:10px;">
                <div class="res-display" style="border:none; color:#7b1fa2;">🏺 秘宝阁</div>
                <div class="sub-stat">待开宝箱: <span id="chest-count" class="highlight">0</span></div>
                <div class="sub-stat">剩余次数: <span id="treasure-daily">20 / 20</span></div>
                <div class="sub-stat">秘宝碎片: <span id="treasure-frags">0</span></div>
                <button class="sys-btn btn-treasure" onclick="game.openTreasureModal()">🚪 进入秘宝阁</button>
                <div style="font-size:0.7rem; color:#888; margin-top:5px;">
                    * 通关副本获得宝箱<br>
                    * 每日20次开启限制
                </div>
            </div>
        </div>

        <!-- Realm Breakthrough Tab (境界突破 - 独立标签) -->
        <div id="tab-realm" class="tab-content">
            <div class="system-section">
                <div class="res-display" style="border:none; color:#ffd700;">✨ 境界突破</div>
                <div class="sub-stat">当前境界: <span id="realm-name" class="val highlight">凡人-武者</span></div>
                <div class="sub-stat">境界加成: <span id="realm-bonus" class="val">x1.00</span> (全属性)</div>
                <div class="sub-stat">下一境界: <span id="next-realm" class="val">练气-初期</span></div>
                <div class="sub-stat">突破需求: 历史最高难度达到 <span id="realm-req" class="val highlight">N4</span></div>
                <div class="sub-stat">当前进度: <span id="realm-progress" class="val">1/4 (25%)</span></div>
                
                <button class="sys-btn btn-realm" id="btn-realm-challenge" onclick="game.summonRealmBoss()" disabled>🔒 难度不足</button>
                <div style="font-size:0.7rem; color:#888; margin-top:5px;">
                    * 达到指定难度后可挑战境界天劫<br>
                    * 击败天劫BOSS即可突破境界<br>
                    * 突破后获得全属性加成
                </div>
            </div>
        </div>

        <!-- Spirit Garden Tab (百草灵园 - 概览入口) -->
        <div id="tab-garden" class="tab-content">
            <div class="system-section">
                <div class="res-display" style="border:none; color:#22c55e;">🌿 百草灵园</div>
                
                <!-- 等级和转数 -->
                <div class="sub-stat">
                    <span>灵植等级:</span>
                    <span>Lv.<span id="garden-overview-level" class="val highlight">1</span> 
                    (<span id="garden-overview-turn">凡阶</span>)</span>
                </div>
                
                <!-- 灵石和收入 -->
                <div class="sub-stat">
                    <span>灵石储备:</span>
                    <span id="garden-overview-stones" class="val">100</span>
                </div>
                <div class="sub-stat">
                    <span>灵石收入:</span>
                    <span id="garden-overview-income" class="val highlight" style="color:#22c55e;">+0/分</span>
                </div>
                <div class="sub-stat">
                    <span>经验获取:</span>
                    <span id="garden-overview-exp" class="val highlight" style="color:#3b82f6;">+0/分</span>
                </div>
                
                <!-- 土地状态 -->
                <div class="sub-stat">
                    <span>已开垦:</span>
                    <span><span id="garden-overview-lands">4</span>/16 块</span>
                </div>
                <div class="sub-stat">
                    <span>可收获:</span>
                    <span id="garden-overview-mature" class="val highlight" style="color:#fbbf24;">0</span>
                </div>
                
                <!-- 进入灵植园按钮 -->
                <button class="sys-btn btn-garden" onclick="game.openGardenModal()" style="margin-top:10px; background:linear-gradient(to right, #15803d, #22c55e);">
                    <i class="fas fa-leaf"></i> 进入灵植园
                </button>
                
                <div style="font-size:0.7rem; color:#888; margin-top:5px;">
                    * 灵植自动生长，收获获得灵石<br>
                    * 灵植经验自动转化为法则真意<br>
                    * 傀儡托管自动收获和种植
                </div>
            </div>
        </div>
    </div>
</div>

<div id="tooltip"></div>

<!-- Item Modal -->
<div id="item-modal" class="game-modal" style="z-index: 2000;">
    <div class="modal-content">
        <h3 id="modal-title" style="margin-top:0;">Item Name</h3>
        <p id="modal-desc" style="color:#aaa; font-size:0.9rem;">Stats</p>
        <div id="modal-actions">
            <!-- Buttons injected by JS -->
        </div>
        <button class="modal-btn btn-close" onclick="game.closeModal('item-modal')">关闭</button>
    </div>
</div>

<!-- Treasure Full Screen Modal -->
<div id="treasure-full-modal" class="game-modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #444; padding-bottom:10px;">
            <h2 style="margin:0; color:#7b1fa2;">秘宝阁</h2>
            <button class="modal-btn btn-close" style="width:auto; margin:0;" onclick="game.closeModal('treasure-full-modal')">✕</button>
        </div>
        
        <div class="treasure-layout">
            <!-- Left: Equipped -->
            <div class="treasure-left-panel">
                <div style="font-weight:bold; margin-bottom:10px; color:#aaa;">已装备秘宝 (右键卸下)</div>
                <div class="equip-grid" id="treasure-equip-grid" style="grid-template-columns: repeat(2, 1fr); gap: 8px;">
                    <!-- Slots -->
                </div>
                
                <div style="margin-top:auto; font-size:0.8rem; color:#888;">
                    <div class="sub-stat">待开宝箱: <span id="modal-chest-count" class="highlight">0</span></div>
                    <div class="sub-stat">剩余次数: <span id="modal-daily-count">20</span></div>
                    <div class="sub-stat">秘宝碎片: <span id="modal-frag-count">0</span></div>
                </div>
            </div>

            <!-- Right: Bag & Controls -->
            <div class="treasure-right-panel">
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <button class="sys-btn btn-treasure" style="flex:1; margin:0;" onclick="game.openTreasureBox(1)">🎁 开启宝箱 (消耗1次)</button>
                    <button class="sys-btn btn-treasure" style="flex:1; margin:0;" onclick="game.exchangeTreasure()">♻️ 碎片兑换</button>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <span style="font-weight:bold; color:#aaa;">秘宝背包 (右键穿戴/替换)</span>
                    <button onclick="game.autoDecompose()" style="font-size:0.8rem; padding:4px 8px; background:#f44336; border:none; color:white; cursor:pointer;">一键分解</button>
                </div>
                
                <div class="treasure-bag-grid" id="treasure-bag">
                    <!-- Bag Items -->
                </div>

                <div style="margin-top:10px; border-top:1px solid #444; padding-top:10px; display:flex; gap:5px;">
                    <input type="text" id="redeem-code-modal" placeholder="输入兑换码" style="flex:1; padding:5px; background:#111; border:1px solid #444; color:#fff;">
                    <button onclick="game.redeemCode('modal')" style="padding:5px 15px;">兑换</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Garden Full Screen Modal -->
<div id="garden-full-modal" class="game-modal" style="z-index: 1500;">
    <div class="modal-content" style="width: 90%; max-width: 800px; height: 90%; display: flex; flex-direction: column;">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #444; padding-bottom:10px; margin-bottom:10px;">
            <h2 style="margin:0; color:#22c55e;">🌿 百草灵园</h2>
            <button class="modal-btn btn-close" style="width:auto; margin:0;" onclick="game.closeGardenModal()">✕</button>
        </div>
        
        <div style="display:flex; gap:15px; flex:1; overflow:hidden;">
            <!-- 左侧：灵植园主界面 -->
            <div style="flex:2; display:flex; flex-direction:column; gap:10px; overflow:hidden;">
                <!-- 状态栏 -->
                <div style="background:#1a1a1a; padding:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-size:1.1rem; font-weight:bold; color:#22c55e;">
                            Lv.<span id="garden-modal-level">1</span> 
                            (<span id="garden-modal-turn">凡阶</span>)
                        </div>
                        <div style="width:150px; height:6px; background:#333; border-radius:3px; margin-top:5px; overflow:hidden;">
                            <div id="garden-modal-exp-bar" style="width:0%; height:100%; background:linear-gradient(90deg, #22c55e, #16a34a);"></div>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:1.2rem; color:#fbbf24; font-weight:bold;">
                            💎 <span id="garden-modal-stones">100</span>
                        </div>
                        <div style="font-size:0.75rem; color:#888;">
                            <span style="color:#22c55e;" id="garden-modal-income">+0/分</span> | 
                            <span style="color:#3b82f6;" id="garden-modal-exp-rate">+0/分</span>
                        </div>
                    </div>
                </div>
                
                <!-- 土地网格 -->
                <div style="flex:1; background:#1a1a1a; border-radius:8px; padding:10px; overflow-y:auto;">
                    <div id="modal-land-grid" class="garden-land-grid" style="grid-template-columns: repeat(4, 1fr);">
                        <!-- 由JS生成 -->
                    </div>
                </div>
                
                <!-- 操作按钮 -->
                <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:8px;">
                    <button class="sys-btn" style="background:linear-gradient(to right, #15803d, #22c55e); font-size:0.8rem; padding:8px;" onclick="game.gardenOneClickHarvest()">
                        <i class="fas fa-hand-holding-dollar"></i> 一键收获
                    </button>
                    <button class="sys-btn" style="background:linear-gradient(to right, #1d4ed8, #3b82f6); font-size:0.8rem; padding:8px;" onclick="game.gardenOneClickPlant()">
                        <i class="fas fa-seedling"></i> 一键种植
                    </button>
                    <button class="sys-btn" style="background:linear-gradient(to right, #991b1b, #dc2626); font-size:0.8rem; padding:8px;" onclick="game.gardenOneClickClear()">
                        <i class="fas fa-trash-alt"></i> 铲除未熟
                    </button>
                    <button id="modal-puppet-btn" class="sys-btn" style="background:linear-gradient(to right, #581c87, #9333ea); font-size:0.8rem; padding:8px; opacity:0.6;" onclick="game.togglePuppetMode()" disabled>
                        <i class="fas fa-robot"></i> 傀儡
                    </button>
                </div>
            </div>
            
            <!-- 右侧：灵植阁 -->
            <div style="flex:1; display:flex; flex-direction:column; gap:10px; min-width:200px;">
                <div style="background:#1a1a1a; padding:10px; border-radius:8px; flex:1; display:flex; flex-direction:column;">
                    <h3 style="margin:0 0 10px 0; color:#16a34a; font-size:1rem;">🏪 灵植阁</h3>
                    
                    <!-- 转数选择器 -->
                    <div style="padding-bottom:8px; margin-bottom:8px; border-bottom:1px solid #333;">
                        <label style="font-size:0.75rem; color:#9ca3af; margin-bottom:4px; display:block;">选择转数</label>
                        <select id="modal-turn-selector" onchange="game.garden.setShopTurn(parseInt(this.value)); game.updateGardenUI();" style="width:100%; padding:6px; background:#262626; border:1px solid #4b5563; border-radius:4px; color:#fff; font-size:0.85rem;">
                            <!-- 由JS生成 -->
                        </select>
                    </div>
                    
                    <!-- 工具栏 -->
                    <div id="modal-shovel-btn" class="tool-btn" style="padding:8px; background:#374151; border-radius:6px; display:flex; align-items:center; gap:8px; border:1px solid #4b5563; margin-bottom:8px;">
                        <span style="font-size:1.3rem;">⛏️</span>
                        <div style="pointer-events:none;">
                            <div style="font-size:0.85rem; color:#f87171; font-weight:bold;">玉灵铲</div>
                            <div style="font-size:0.7rem; color:#9ca3af;">点击植物单体移除</div>
                        </div>
                    </div>
                    
                    <!-- 种子列表 -->
                    <div id="modal-seed-list" style="flex:1; overflow-y:auto; background:#262626; border-radius:6px; padding:6px;">
                        <!-- 由JS生成 -->
                    </div>
                    
                    <!-- 丹火提炼 -->
                    <div id="modal-alchemy-toggle" style="display:none; margin-top:8px; padding:8px; background:#262626; border-radius:6px; align-items:center; justify-content:space-between;">
                        <div>
                            <span style="color:#f97316;">🔥 丹火提炼</span>
                            <span style="font-size:0.7rem; color:#888; margin-left:5px;">+20%收益</span>
                        </div>
                        <button id="modal-alchemy-btn" onclick="game.toggleAlchemyMode();" style="padding:4px 12px; background:#374151; border:none; border-radius:4px; color:#fff; font-size:0.75rem; cursor:pointer;">OFF</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cheat Modal -->
<div id="cheat-modal" class="game-modal">
    <div class="modal-content">
        <h3 style="margin-top:0; color:#ff1744;">🔥 金手指修改器</h3>
        <select id="cheat-type" class="cheat-select">
            <option value="atk">增加基础攻击力</option>
            <option value="hp">增加基础生命值</option>
            <option value="curHp">恢复当前生命值</option>
            <option value="law">增加法则真意</option>
            <option value="chest">增加秘宝宝箱</option>
            <option value="frag">增加秘宝碎片</option>
            <option value="ticket">增加秘宝次数</option>
            <option value="realm">增加境界等级</option>
            <option value="diff">增加历史最高难度</option>
            <option value="gardenExp">灵植经验倍率</option>
            <option value="gardenStone">灵植灵石倍率</option>
        </select>
        <input type="text" id="cheat-val" class="cheat-input" placeholder="输入数值 (支持 1e100)">
        <div style="font-size:0.8rem; color:#888;">支持极大数值，输入过大将变为∞</div>
        <button class="modal-btn btn-use" onclick="game.applyCheat()">确认修改</button>
        <button class="modal-btn btn-close" onclick="game.closeModal('cheat-modal')">关闭</button>
    </div>
</div>

<!-- Core Scripts -->
<script src="js/core/BigNum.js"></script>
<script src="js/config.js"></script>
<script src="js/utils.js"></script>
<script src="js/classes/Item.js"></script>
<script src="js/classes/Treasure.js"></script>
<script src="js/classes/Dungeon.js"></script>
<script src="js/classes/SpiritGarden.js"></script>
<script src="js/game/Game.js"></script>

<!-- Initialize Game -->
<script>
const game = new Game();
</script>

</body>
</html>
