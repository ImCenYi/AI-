<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµæ¤å›­ - æ— é™è¿›åŒ–</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Serif SC', serif;
            background-color: #111827;
            background-image: radial-gradient(circle at 50% 50%, #1f2937 0%, #111827 100%);
            color: #d1d5db;
        }

        /* åœŸåœ°ç½‘æ ¼ */
        .land-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr); 
            gap: 0.5rem;
        }
        @media (max-width: 768px) {
            .land-grid { grid-template-columns: repeat(4, 1fr); } 
        }

        /* é€‰ä¸­ç§å­åŠ¨ç”» */
        .selected-seed {
            border-color: #f59e0b !important;
            background-color: rgba(245, 158, 11, 0.1);
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.3);
        }
        
        /* é“²å­æ¨¡å¼ï¼šå…¨å±€è­¦å‘Š */
        .shovel-mode-active {
            border: 2px dashed #ef4444 !important;
            background-color: rgba(239, 68, 68, 0.05);
        }
        
        /* é“²å­æ¨¡å¼ä¸‹çš„å…‰æ ‡ */
        .cursor-shovel .land-item {
            cursor: no-drop !important; 
        }

        /* æµ®åŠ¨æ–‡å­— */
        .float-text {
            position: absolute;
            animation: floatUp 1.2s ease-out forwards;
            pointer-events: none;
            font-weight: bold;
            z-index: 50;
            text-shadow: 1px 1px 2px black;
            font-size: 0.8rem;
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-40px) scale(1.2); opacity: 0; }
        }

        /* å‚€å„¡å·¥ä½œçš„å…‰æ•ˆ */
        .puppet-working {
            box-shadow: inset 0 0 10px rgba(168, 85, 247, 0.5);
            border-color: #a855f7 !important;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* å•†åº—å±‚çº§æ ‡ç­¾é«˜äº® */
        .tab-active {
            background-color: #374151;
            color: #fbbf24;
            border-bottom: 2px solid #fbbf24;
        }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col p-2">

<div id="app" class="flex-1 flex flex-col md:flex-row max-w-7xl mx-auto w-full gap-3 h-full">

    <!-- å·¦ä¾§ï¼šè¯å›­ä¸»ç•Œé¢ -->
    <div class="flex-[2] flex flex-col gap-2 bg-gray-900 border border-gray-700 rounded-xl p-3 shadow-2xl relative overflow-hidden h-full">
        
        <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
        <div class="flex justify-between items-end border-b border-gray-700 pb-2 z-10 shrink-0">
            <div>
                <h1 class="text-xl font-bold text-yellow-500 tracking-widest flex items-center"><i class="fas fa-leaf mr-2"></i>ç™¾è‰çµå›­</h1>
                <div class="text-xs mt-1 flex items-center gap-2">
                    <span class="px-1.5 py-0.5 bg-gray-800 rounded border border-gray-600 text-blue-300 font-mono font-bold">Lv.{{ playerLevel }}</span>
                    <span class="text-gray-400">ç»éªŒ: {{ formatNumber(cultivation) }} / {{ formatNumber(maxCultivation) }}</span>
                </div>
                <div class="w-40 h-1 bg-gray-800 rounded-full mt-1 overflow-hidden">
                    <div class="h-full bg-blue-600 transition-all duration-500" :style="{ width: Math.min(100, cultivation/maxCultivation*100) + '%' }"></div>
                </div>
            </div>
            <div class="text-right">
                <div class="text-xl font-bold text-yellow-400 font-mono">
                    {{ formatNumber(spiritStones) }} <span class="text-xs text-gray-500">çµçŸ³</span>
                </div>
                <div class="text-[10px] text-green-500" v-if="incomeRate > 0">
                    <i class="fas fa-arrow-up"></i> {{ formatNumber(incomeRate) }}/åˆ†
                </div>
            </div>
        </div>

        <!-- æµ®åŠ¨æ–‡å­—å±‚ -->
        <div class="absolute inset-0 pointer-events-none overflow-hidden z-50">
            <div v-for="text in floatingTexts" :key="text.id" class="float-text" 
                 :style="{ left: text.x + 'px', top: text.y + 'px', color: text.color }">
                {{ text.content }}
            </div>
        </div>

        <!-- åœŸåœ°å±•ç¤ºåŒº -->
        <div class="flex-1 overflow-y-auto p-2 bg-gray-800/30 rounded-lg border border-gray-700/50 relative transition-all duration-300"
             :class="{'shovel-mode-active cursor-shovel': selectedSeedId === -1}">
            
            <div class="land-grid">
                <div v-for="(land, index) in lands" :key="index" 
                     class="land-item aspect-square relative rounded border transition-all duration-200 cursor-pointer group select-none flex flex-col items-center justify-center p-1"
                     :class="[getLandStyle(land), {'puppet-working': autoMode && land.unlocked && playerLevel >= 2}]"
                     @click="handleLandClick(index, $event)">
                    
                    <!-- 1. æœªè§£é” -->
                    <div v-if="!land.unlocked" class="text-center opacity-60">
                        <i class="fas fa-lock text-xl mb-1"></i>
                        <div class="text-[10px] font-mono text-yellow-600">{{ formatNumber(land.unlockCost) }}</div>
                    </div>

                    <!-- 2. ç©ºé—² (æ˜¾ç¤ºä¸Šä¸€æ¬¡ç§æ¤çš„è®°å¿†) -->
                    <div v-else-if="!land.plant" class="text-center text-gray-600 group-hover:text-green-500 transition-colors">
                        <div v-if="autoMode && land.lastSeedId && playerLevel >= 2" class="animate-pulse text-purple-400">
                            <i class="fas fa-magic text-xl"></i>
                            <div class="text-[10px] scale-75">è¡¥ç§ä¸­...</div>
                        </div>
                        <div v-else>
                            <i class="fas fa-plus-circle text-2xl opacity-30 group-hover:opacity-100"></i>
                            <div class="text-[10px] mt-1 opacity-0 group-hover:opacity-100">ç§æ¤</div>
                        </div>
                    </div>

                    <!-- 3. ç”Ÿé•¿ä¸­/æˆç†Ÿ -->
                    <div v-else class="w-full h-full flex flex-col items-center justify-center relative gap-1">
                        
                        <!-- é“²å­æ¨¡å¼ä¸‹çš„çº¢è‰²å‰å‰ -->
                        <div v-if="selectedSeedId === -1" class="absolute inset-0 bg-red-900/60 z-20 flex items-center justify-center animate-pulse rounded border-2 border-red-500">
                            <i class="fas fa-trash-alt text-white text-3xl"></i>
                        </div>

                        <div class="text-2xl transition-transform duration-500 transform" 
                             :class="land.progress >= 100 ? 'scale-110 drop-shadow-[0_0_5px_rgba(255,255,255,0.5)]' : 'scale-90 opacity-80'">
                            {{ land.plant.icon }}
                        </div>
                        
                        <div v-if="land.progress < 100" class="w-full h-1 bg-gray-900 rounded-full overflow-hidden absolute bottom-1 left-0 px-1">
                            <div class="h-full bg-green-500 transition-all duration-300 rounded-full" :style="{ width: land.progress + '%' }"></div>
                        </div>
                        
                        <div v-if="land.progress >= 100" class="absolute top-1 right-1">
                            <span class="flex h-2 w-2">
                              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span>
                              <span class="relative inline-flex rounded-full h-2 w-2 bg-yellow-500"></span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨æ“ä½œæ  -->
        <div class="grid grid-cols-4 gap-2 h-12 shrink-0 mt-2">
            <button @click="oneClickHarvest" class="bg-green-800 hover:bg-green-700 text-green-100 rounded text-xs border-b-2 border-green-950 active:border-b-0 active:translate-y-0.5 transition-all flex flex-col items-center justify-center">
                <i class="fas fa-hand-holding-dollar mb-1"></i> <span>ä¸€é”®æ”¶è·</span>
            </button>
            
            <button @click="oneClickPlant" 
                    :disabled="selectedSeedId === -1"
                    class="bg-blue-800 hover:bg-blue-700 text-blue-100 rounded text-xs border-b-2 border-blue-950 active:border-b-0 active:translate-y-0.5 transition-all flex flex-col items-center justify-center disabled:opacity-50">
                <i class="fas fa-seedling mb-1"></i> <span>ä¸€é”®ç§æ¤</span>
            </button>
            
            <button @click="oneClickClear" class="bg-red-900 hover:bg-red-800 text-red-100 rounded text-xs border-b-2 border-black active:border-b-0 active:translate-y-0.5 transition-all flex flex-col items-center justify-center">
                <i class="fas fa-trash-alt mb-1"></i> <span>é“²é™¤æœªç†Ÿ</span>
            </button>
            
            <!-- å‚€å„¡æ‰˜ç®¡ -->
            <div class="bg-gray-800 rounded border border-gray-600 flex flex-col items-center justify-center relative overflow-hidden cursor-pointer hover:bg-gray-750" 
                 :class="{'opacity-50 cursor-not-allowed': playerLevel < 2, 'border-purple-500 ring-1 ring-purple-500 bg-gray-800': autoMode}"
                 @click="playerLevel >= 2 ? autoMode = !autoMode : null">
                
                <i class="fas mb-1" :class="autoMode ? 'fa-robot text-purple-400' : 'fa-robot text-gray-500'"></i>
                <span class="text-xs select-none" :class="autoMode ? 'text-purple-200' : 'text-gray-400'">
                    å‚€å„¡æ‰˜ç®¡ <span v-if="autoMode" class="text-green-400 ml-1">ON</span>
                </span>

                <div v-if="playerLevel < 2" class="absolute inset-0 bg-black/80 flex items-center justify-center text-[10px] text-red-400 z-20 backdrop-blur-sm">
                    Lv.2 è§£é”
                </div>
            </div>
        </div>
    </div>

    <!-- å³ä¾§ï¼šåŠŸèƒ½é¢æ¿ -->
    <div class="flex-1 md:flex-[1] flex flex-col gap-3 min-w-[280px] h-full overflow-hidden">
        
        <!-- çµæ¤å•†åº— -->
        <div class="flex-[2] bg-gray-900 border border-gray-700 rounded-xl p-3 flex flex-col min-h-0">
            <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-2 shrink-0">
                <h2 class="font-bold text-gray-200 text-sm"><i class="fas fa-store text-yellow-600 mr-2"></i>çµæ¤é˜</h2>
                <div class="flex items-center gap-2">
                    <span class="text-[10px] text-gray-500" v-if="selectedSeedId === -1">âš ï¸ é“²é™¤æ¨¡å¼</span>
                    <span class="text-[10px] text-gray-500" v-else>è´­ä¹°ç§å­</span>
                </div>
            </div>
            
            <!-- å±‚çº§é€‰æ‹©å™¨ (Turn Selector) -->
            <div class="flex overflow-x-auto gap-1 pb-2 mb-2 border-b border-gray-700 custom-scroll">
                <button v-for="(turnName, t) in TURN_NAMES" :key="t"
                        @click="shopTurn = t"
                        v-show="unlockedTurns >= t"
                        class="px-3 py-1 rounded text-[10px] whitespace-nowrap transition-colors border border-gray-700 hover:bg-gray-800"
                        :class="shopTurn === t ? 'tab-active' : 'bg-gray-800/50 text-gray-400'">
                    {{ turnName }}
                </button>
            </div>
            
            <!-- å·¥å…·åŒº -->
            <div class="pb-2 mb-2 border-b border-gray-700 shrink-0">
                <div @click="selectedSeedId = -1"
                     class="p-2 rounded border transition-all cursor-pointer flex items-center justify-between group shadow-sm"
                     :class="selectedSeedId === -1 ? 'bg-red-900/50 border-red-500 ring-1 ring-red-500' : 'border-gray-700 bg-gray-800 hover:bg-gray-700'">
                    <div class="flex items-center gap-3">
                        <div class="text-2xl w-8 text-center">â›ï¸</div>
                        <div>
                            <div class="text-sm font-bold text-red-400">ç‰çµé“²</div>
                            <div class="text-[10px] text-gray-400">ç‚¹å‡»æ¤ç‰©å•ä½“ç§»é™¤</div>
                        </div>
                    </div>
                    <div class="text-xs text-red-500 font-bold" v-if="selectedSeedId === -1">
                        <i class="fas fa-check"></i> ä½¿ç”¨ä¸­
                    </div>
                </div>
            </div>

            <!-- ç§å­åˆ—è¡¨ -->
            <div class="flex-1 overflow-y-auto space-y-1.5 pr-1 custom-scroll">
                <div v-for="seed in seedsInShop" :key="seed.id"
                     @click="selectSeed(seed.id)"
                     class="relative p-1.5 rounded border transition-all cursor-pointer flex items-center justify-between group"
                     :class="selectedSeedId === seed.id ? 'selected-seed bg-gray-800' : 'border-gray-800/40 hover:bg-gray-800'">
                    
                    <div class="flex items-center gap-2">
                        <div class="text-xl w-8 text-center">{{ seed.icon }}</div>
                        <div>
                            <div class="text-xs font-bold" :class="getQualityColor(seed.quality)">{{ seed.name }}</div>
                            <div class="text-[10px] text-gray-500 flex gap-2">
                                <span><i class="far fa-clock"></i> {{ seed.time }}s</span>
                                <span><i class="fas fa-arrow-up"></i> {{ formatNumber(seed.exp) }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="text-right leading-tight">
                        <div class="text-[10px] text-red-400 font-mono">-{{ formatNumber(seed.cost) }}</div>
                        <div class="text-[10px] text-green-400 font-mono">+{{ formatNumber(seed.income) }}</div>
                    </div>

                    <div v-if="selectedSeedId === seed.id" class="absolute right-0 top-0 text-yellow-500 text-[10px] p-0.5">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>

                <!-- æ˜¾ç¤ºä¸‹ä¸€çº§è§£é”æç¤º -->
                <div v-if="nextUnlockInTurn" class="p-2 border border-dashed border-gray-700 rounded text-center text-gray-500 text-[10px] mt-2">
                    <i class="fas fa-lock mb-1"></i>
                    ä¸‹çº§ [{{ nextUnlockInTurn.name }}] éœ€ <span class="text-blue-400">Lv.{{ nextUnlockInTurn.reqLevel }}</span>
                </div>
                <!-- è·¨å±‚çº§æç¤º -->
                <div v-else-if="unlockedTurns > shopTurn" class="p-2 border border-dashed border-purple-900/50 rounded text-center text-purple-400 text-[10px] mt-2 cursor-pointer hover:bg-purple-900/20" @click="shopTurn++">
                    <i class="fas fa-arrow-up mb-1"></i>
                    æœ¬é˜¶å·²ä¿®æ»¡ï¼Œç‚¹å‡»è¿›å…¥ä¸‹ä¸€è½¬ (Lv.{{ (shopTurn + 1) * 100 + 1 }})
                </div>
            </div>
        </div>

        <!-- ç³»ç»Ÿä¸è®¾ç½® -->
        <div class="bg-gray-900 border border-gray-700 rounded-xl p-3 shrink-0">
            <h2 class="font-bold text-gray-200 mb-2 border-b border-gray-700 pb-1 text-sm flex justify-between">
                <span><i class="fas fa-cogs text-gray-400 mr-2"></i>ç³»ç»Ÿè®¾ç½®</span>
                <span class="text-[10px] text-gray-500">æ¯5ç§’è‡ªåŠ¨å­˜æ¡£</span>
            </h2>
            <div class="space-y-2 text-xs">
                
                <!-- äº§ä¸šé“¾ï¼šç‚¼ä¸¹ -->
                <div class="flex justify-between items-center" :class="{'opacity-50': playerLevel < 10}">
                    <div>
                        <div class="text-gray-300">ä¸¹ç«æç‚¼ <span class="text-yellow-500 text-[10px]">+20%æ”¶ç›Š</span></div>
                    </div>
                    <div v-if="playerLevel < 10" class="text-[10px] text-red-500">Lv.10 è§£é”</div>
                    <div v-else @click="alchemyMode = !alchemyMode" class="cursor-pointer">
                        <i class="fas text-lg transition-colors" :class="alchemyMode ? 'fa-toggle-on text-purple-500' : 'fa-toggle-off text-gray-500'"></i>
                    </div>
                </div>

                <!-- æ‰‹åŠ¨å­˜æ¡£æ“ä½œåŒº -->
                <div class="flex gap-2 mt-2 pt-2 border-t border-gray-800">
                    <button @click="manualSave" class="flex-1 bg-blue-900 hover:bg-blue-800 text-blue-100 py-1 px-2 rounded text-[10px] flex items-center justify-center gap-1 transition-colors">
                        <i class="fas fa-save"></i> æ‰‹åŠ¨å­˜æ¡£
                    </button>
                    <button @click="resetData" class="flex-1 bg-red-900/50 hover:bg-red-800 text-red-100 py-1 px-2 rounded text-[10px] flex items-center justify-center gap-1 transition-colors border border-red-900">
                        <i class="fas fa-redo"></i> åˆ æ¡£é‡ç»ƒ
                    </button>
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—çª—å£ -->
        <div class="flex-[1] bg-black/80 rounded-xl p-2 overflow-y-auto text-[10px] font-mono border border-gray-800 min-h-[80px]" ref="logContainer">
            <div v-for="(log, i) in logs" :key="i" class="mb-0.5 border-b border-gray-800/50 pb-0.5 last:border-0">
                <span class="text-gray-500">[{{ log.time }}]</span> 
                <span :class="log.color">{{ log.msg }}</span>
            </div>
        </div>

    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

    // åŸºç¡€ç§å­æ•°æ®
    // é‡æ–°è®¾è®¡ï¼šæ‹‰å¤§åŒä¸€é˜¶å±‚çš„è§£é”ç­‰çº§ï¼Œå¡«æ»¡ 1-95 çº§
    // XPæ•ˆç‡ï¼šé‡ç‚¹æ˜¯æ§åˆ¶XPäº§å‡ºï¼Œä¿è¯XPæ˜¯é™åˆ¶ç­‰çº§çš„å…³é”®
    const BASE_SEEDS = [
        { id: 1, name: "å‡æ°”è‰", quality: 0, icon: "ğŸŒ¿", time: 3, cost: 10, income: 15000, exp: 5000, reqLevel: 1 },
        { id: 2, name: "è¡€è©æ", quality: 1, icon: "ğŸ’", time: 10, cost: 100, income: 250, exp: 25, reqLevel: 3 }, 
        { id: 3, name: "ç„å†°èŠ±", quality: 2, icon: "â„ï¸", time: 30, cost: 800, income: 2400, exp: 120, reqLevel: 10 },
        { id: 4, name: "ç´«é‡‘è—¤", quality: 3, icon: "ğŸ‹", time: 60, cost: 3000, income: 10000, exp: 400, reqLevel: 25 },
        { id: 5, name: "é¾™é³æœ", quality: 4, icon: "ğŸ²", time: 120, cost: 15000, income: 60000, exp: 1500, reqLevel: 45 },
        { id: 6, name: "æ‚Ÿé“èŒ¶", quality: 5, icon: "ğŸµ", time: 300, cost: 80000, income: 400000, exp: 6000, reqLevel: 65 },
        { id: 7, name: "æ··æ²Œè²", quality: 5, icon: "ğŸª·", time: 600, cost: 500000, income: 3000000, exp: 20000, reqLevel: 80 },
    ];

    // ç”Ÿæˆ0-9è½¬çš„å®Œæ•´ç§å­åˆ—è¡¨
    const TURN_NAMES = ["å‡¡é˜¶", "1è½¬", "2è½¬", "3è½¬", "4è½¬", "5è½¬", "6è½¬", "7è½¬", "8è½¬", "9è½¬"];
    const ALL_SEEDS = [];

    // æ ¸å¿ƒæ•°å€¼å¹³è¡¡ï¼š
    // æ¯è½¬å¢åŠ 100å€æ”¶ç›Š/æˆæœ¬
    // æ¯è½¬å¢åŠ 100å€ç»éªŒ => ä¸ºäº†åŒ¹é…æŒ‡æ•°å¢é•¿çš„ç­‰çº§éœ€æ±‚
    // Turn Span: 100 levels
    for (let t = 0; t < 10; t++) {
        BASE_SEEDS.forEach(seed => {
            const multiplier = Math.pow(100, t); // 100å€å€ç‡
            
            // ç»éªŒå€ç‡éœ€è¦ç¨é«˜ï¼Œä»¥åŒ¹é… 1.05^100 â‰ˆ 131å€ çš„å‡çº§éœ€æ±‚å¢é•¿
            // ä½¿ç”¨100å€ç»éªŒå€ç‡æ„å‘³ç€å‡çº§ä¼šç¨å¾®å˜éš¾ä¸€ç‚¹ç‚¹ï¼Œç¬¦åˆåæœŸæ”¾ç¼“çš„èŠ‚å¥
            const expMultiplier = Math.pow(100, t);

            ALL_SEEDS.push({
                ...seed,
                id: seed.id + t * 1000,
                name: t === 0 ? seed.name : `${t}è½¬Â·${seed.name}`,
                cost: Math.floor(seed.cost * multiplier),
                income: Math.floor(seed.income * multiplier),
                exp: Math.floor(seed.exp * expMultiplier),
                reqLevel: seed.reqLevel + t * 100, // æ¯è½¬è·¨åº¦ 100 çº§
                turn: t
            });
        });
    }

    createApp({
        setup() {
            const spiritStones = ref(100);
            const cultivation = ref(0);
            const playerLevel = ref(1); 
            const autoMode = ref(false); 
            const alchemyMode = ref(false); 
            const selectedSeedId = ref(1);
            const shopTurn = ref(0); 
            
            const lands = ref(Array.from({ length: 16 }, (_, i) => ({
                id: i,
                unlocked: i < 4,
                unlockCost: Math.floor(200 * Math.pow(2.5, i)),
                plant: null, 
                progress: 0,
                lastSeedId: null 
            })));

            const logs = ref([]);
            const floatingTexts = ref([]);
            const logContainer = ref(null);

            // å‡çº§å…¬å¼è°ƒæ•´ï¼š
            // 1.05 ^ 100 â‰ˆ 131.5
            // è¿™æ„å‘³ç€æ¯100çº§ï¼Œå‡çº§æ‰€éœ€ç»éªŒå¢åŠ çº¦130å€ã€‚
            // è€Œæˆ‘ä»¬çš„ä½œç‰©ç»éªŒæ¯è½¬å¢åŠ 100å€ã€‚
            // è¿™æ ·è®¾è®¡ä¿è¯äº†æ¸¸æˆåæœŸå‡çº§ä¼šè¶Šæ¥è¶Šæœ‰æŒ‘æˆ˜æ€§ï¼Œä¸ä¼šæ•°å€¼å´©åã€‚
            const maxCultivation = computed(() => {
                return Math.floor(100 * Math.pow(1.0475, playerLevel.value));
            });

            // è§£é”å±‚çº§è®¡ç®— (æ¯100çº§ä¸€è½¬)
            const unlockedTurns = computed(() => Math.min(9, Math.floor((playerLevel.value - 1) / 100)));

            const seedsInShop = computed(() => {
                return ALL_SEEDS.filter(s => s.turn === shopTurn.value && s.reqLevel <= playerLevel.value);
            });

            const nextUnlockInTurn = computed(() => {
                return ALL_SEEDS.find(s => s.turn === shopTurn.value && s.reqLevel > playerLevel.value);
            });
            
            const incomeRate = computed(() => {
                if (selectedSeedId.value === -1) return 0;
                const seed = ALL_SEEDS.find(s => s.id === selectedSeedId.value);
                if (!seed) return 0;
                const activeLands = lands.value.filter(l => l.unlocked).length;
                const profitPerHarvest = seed.income - seed.cost;
                const harvestsPerMin = 60 / seed.time;
                let total = activeLands * profitPerHarvest * harvestsPerMin;
                if (alchemyMode.value) total *= 1.2;
                return Math.floor(total);
            });

            const formatNumber = (num) => {
                if (num === Infinity) return "âˆ";
                const units = ["", "ä¸‡", "äº¿", "å…†", "äº¬", "å“", "ç§­", "ç©°", "æ²Ÿ", "æ¶§", "æ­£", "è½½"];
                let unitIndex = 0;
                let val = num;
                while (val >= 10000 && unitIndex < units.length - 1) {
                    val /= 10000;
                    unitIndex++;
                }
                if (unitIndex === 0) return Math.floor(val);
                return val.toFixed(2) + units[unitIndex];
            };

            const getQualityColor = (q) => {
                return ['text-gray-300', 'text-green-400', 'text-blue-400', 'text-purple-400', 'text-yellow-400', 'text-red-500'][q] || 'text-gray-300';
            };

            const getLandStyle = (land) => {
                if (!land.unlocked) return 'bg-black/40 border-gray-800';
                if (!land.plant) return 'bg-gray-800 border-gray-600 hover:border-gray-400';
                if (land.progress >= 100) return 'bg-gray-800 border-yellow-500 shadow-[inset_0_0_20px_rgba(234,179,8,0.2)]';
                return 'bg-gray-800 border-green-800';
            };

            const addLog = (msg, color = 'text-gray-300') => {
                const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
                logs.value.unshift({ time, msg, color });
                if (logs.value.length > 30) logs.value.pop();
            };

            const addFloat = (x, y, content, color) => {
                const id = Date.now() + Math.random();
                floatingTexts.value.push({ id, x, y, content, color });
                setTimeout(() => floatingTexts.value = floatingTexts.value.filter(t => t.id !== id), 1200);
            };

            const handleLandClick = (index, event) => {
                const land = lands.value[index];
                const rect = event.target.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                if (selectedSeedId.value === -1) {
                    if (land.plant) {
                        const refund = Math.floor(land.plant.cost * 0.8);
                        spiritStones.value += refund;
                        land.plant = null;
                        land.progress = 0;
                        land.lastSeedId = null;
                        addLog(`ç§»é™¤çµæ¤ï¼Œå›æ”¶ ${formatNumber(refund)} çµçŸ³`, 'text-blue-400');
                        addFloat(centerX, centerY, `+${formatNumber(refund)}`, '#60a5fa');
                    }
                    return;
                }

                if (!land.unlocked) {
                    if (spiritStones.value >= land.unlockCost) {
                        spiritStones.value -= land.unlockCost;
                        land.unlocked = true;
                        addLog(`å¼€è¾Ÿçµç”°æˆåŠŸï¼Œæ¶ˆè€— ${formatNumber(land.unlockCost)} çµçŸ³`, 'text-yellow-400');
                        addFloat(centerX, centerY, 'è§£é”æˆåŠŸ', '#fbbf24');
                    } else {
                        addLog('çµçŸ³ä¸è¶³ï¼Œæ— æ³•å¼€è¾Ÿ', 'text-red-400');
                    }
                    return;
                }

                if (land.plant && land.progress >= 100) {
                    harvest(land, centerX, centerY);
                    return;
                }

                if (!land.plant) {
                    plant(land, selectedSeedId.value, centerX, centerY);
                    return;
                }
            };

            const harvest = (land, x, y) => {
                if (!land.plant) return;
                let money = land.plant.income;
                if (alchemyMode.value && playerLevel.value >= 10) money = Math.floor(money * 1.2);
                const exp = land.plant.exp;
                spiritStones.value += money;
                cultivation.value += exp;
                if (x && y) {
                    addFloat(x, y - 20, `+${formatNumber(money)}çµçŸ³`, '#fbbf24');
                    addFloat(x, y - 40, `+${formatNumber(exp)}ç»éªŒ`, '#4ade80');
                }
                land.lastSeedId = land.plant.id;
                land.plant = null;
                land.progress = 0;
                checkLevelUp();
            };

            const plant = (land, seedId, x, y) => {
                const seed = ALL_SEEDS.find(s => s.id === seedId);
                if (!seed) return;
                if (spiritStones.value >= seed.cost) {
                    spiritStones.value -= seed.cost;
                    land.plant = { ...seed, startTime: Date.now() };
                    land.progress = 0;
                    land.lastSeedId = seed.id;
                    if (x && y) addFloat(x, y, `-${formatNumber(seed.cost)}`, '#f87171');
                } else {
                    if(x) addLog('çµçŸ³ä¸è¶³ï¼Œæ— æ³•è´­ä¹°ç§å­', 'text-red-500');
                }
            };

            const checkLevelUp = () => {
                let leveledUp = false;
                while (cultivation.value >= maxCultivation.value) {
                    cultivation.value -= maxCultivation.value;
                    playerLevel.value++;
                    leveledUp = true;
                }
                
                if (leveledUp) {
                    addLog(`======= æ­å–œï¼ç­‰çº§æå‡è‡³ Lv.${playerLevel.value} =======`, 'text-purple-400 font-bold');
                    // æ£€æŸ¥æ˜¯å¦è§£é”æ–°å±‚çº§ (Lv.101, 201...)
                    if ((playerLevel.value - 1) % 100 === 0 && playerLevel.value > 1) {
                        const newTurn = Math.floor((playerLevel.value - 1) / 100);
                        if (newTurn <= 9) {
                            shopTurn.value = newTurn;
                            addLog(`çµæ¤é˜å·²è§£é” [${TURN_NAMES[shopTurn.value]}] ç§å­ï¼`, 'text-yellow-400');
                        }
                    }
                }
            };

            const oneClickHarvest = (e) => {
                let count = 0;
                lands.value.forEach(l => {
                    if (l.plant && l.progress >= 100) {
                        harvest(l, e?.clientX, e?.clientY);
                        count++;
                    }
                });
                if (count > 0) addLog(`ä¸€é”®æ”¶è·äº† ${count} æ ªçµæ¤`);
            };

            const oneClickPlant = (e) => {
                let count = 0;
                if (selectedSeedId.value === -1) {
                    addLog('å½“å‰ä¸ºé“²å­æ¨¡å¼ï¼Œæ— æ³•ç§æ¤', 'text-red-400');
                    return;
                }
                const seed = ALL_SEEDS.find(s => s.id === selectedSeedId.value);
                lands.value.forEach(l => {
                    if (l.unlocked && !l.plant && spiritStones.value >= seed.cost) {
                        plant(l, selectedSeedId.value, e?.clientX, e?.clientY);
                        count++;
                    }
                });
                if (count > 0) addLog(`ä¸€é”®ç§æ¤äº† ${count} æ ª ${seed.name}`);
            };

            const oneClickClear = () => {
                let count = 0;
                let totalRefund = 0;
                lands.value.forEach(l => {
                    if (l.plant && l.progress < 100) {
                        totalRefund += Math.floor(l.plant.cost * 0.8);
                        l.plant = null;
                        l.progress = 0;
                        l.lastSeedId = null;
                        count++;
                    }
                });
                if (count > 0) {
                    spiritStones.value += totalRefund;
                    addLog(`å·²é“²é™¤ ${count} æ ªç”Ÿé•¿ä¸­çš„çµæ¤ï¼Œå›æ”¶ ${formatNumber(totalRefund)} çµçŸ³`, 'text-blue-400');
                } else {
                    addLog("å½“å‰æ²¡æœ‰æ­£åœ¨ç”Ÿé•¿çš„æ¤ç‰©", "text-yellow-500");
                }
            };

            const selectSeed = (id) => {
                selectedSeedId.value = id;
            };

            const doSave = () => {
                const data = {
                    ss: spiritStones.value,
                    cult: cultivation.value,
                    pl: playerLevel.value, 
                    auto: autoMode.value,
                    alch: alchemyMode.value,
                    lands: lands.value.map(l => ({ 
                        unlocked: l.unlocked, 
                        lastSeedId: l.lastSeedId,
                        plantSeedId: l.plant ? l.plant.id : null,
                        plantStartTime: l.plant ? l.plant.startTime : null
                    }))
                };
                localStorage.setItem('xianxia_save_v5', JSON.stringify(data)); 
                return data;
            };

            const manualSave = () => {
                doSave();
                addLog('æ‰‹åŠ¨å­˜æ¡£æˆåŠŸ', 'text-green-400 font-bold');
            };

            const resetData = () => {
                if(!confirm('ç¡®å®šè¦åˆ æ¡£é‡ç»ƒå—ï¼Ÿæ‰€æœ‰è¿›åº¦å°†ä¸¢å¤±ï¼')) return;
                localStorage.removeItem('xianxia_save_v5'); 
                location.reload();
            };

            onMounted(() => {
                let save = localStorage.getItem('xianxia_save_v5'); 
                
                // å…¼å®¹æ—§å­˜æ¡£ v4
                if (!save) {
                    const oldSave = localStorage.getItem('xianxia_save_v4');
                    if (oldSave) {
                        try {
                            const oldData = JSON.parse(oldSave);
                            save = JSON.stringify({
                                ...oldData,
                                // v4 åˆ° v5 ä¸éœ€è¦ç‰¹æ®Šæ•°æ®è½¬æ¢ï¼Œåªæ˜¯æ•°å€¼æ¨¡å‹å˜äº†
                            });
                            addLog(`æ£€æµ‹åˆ°æ—§å­˜æ¡£ï¼Œå·²å‡çº§è‡³æ•°å€¼å¹³è¡¡ç‰ˆ`, 'text-blue-400');
                        } catch(e) { console.error('è¿ç§»å¤±è´¥', e); }
                    }
                }

                if (save) {
                    try {
                        const data = JSON.parse(save);
                        spiritStones.value = data.ss ?? 100;
                        cultivation.value = data.cult ?? 0;
                        playerLevel.value = data.pl ?? 1; 
                        autoMode.value = data.auto ?? false;
                        alchemyMode.value = data.alch ?? false;
                        if(data.lands) {
                            data.lands.forEach((lData, i) => {
                                if(lands.value[i]) {
                                    lands.value[i].unlocked = lData.unlocked;
                                    lands.value[i].lastSeedId = lData.lastSeedId;
                                    if (lData.plantSeedId) {
                                        const seed = ALL_SEEDS.find(s => s.id === lData.plantSeedId);
                                        if (seed) {
                                            lands.value[i].plant = {
                                                ...seed,
                                                startTime: lData.plantStartTime
                                            };
                                            const now = Date.now();
                                            const elapsed = (now - lData.plantStartTime) / 1000;
                                            lands.value[i].progress = Math.min(100, (elapsed / seed.time) * 100);
                                        }
                                    }
                                }
                            });
                        }
                    } catch(e) { console.error('å­˜æ¡£æŸå', e); }
                }

                setInterval(() => {
                    const now = Date.now();
                    lands.value.forEach(l => {
                        if (l.plant && l.progress < 100) {
                            const elapsed = (now - l.plant.startTime) / 1000;
                            l.progress = Math.min(100, (elapsed / l.plant.time) * 100);
                        }
                    });
                    if (autoMode.value && playerLevel.value >= 2) {
                        lands.value.forEach(l => {
                            if (l.plant && l.progress >= 100) harvest(l);
                            if (l.unlocked && !l.plant && l.lastSeedId) plant(l, l.lastSeedId);
                        });
                    }
                }, 100);

                setInterval(() => { doSave(); }, 5000);
            });

            return {
                spiritStones, cultivation, playerLevel, autoMode, alchemyMode,
                maxCultivation, incomeRate, shopTurn, TURN_NAMES, unlockedTurns,
                seedsInShop, nextUnlockInTurn,
                lands, logs, floatingTexts, selectedSeedId,
                formatNumber, getQualityColor, getLandStyle,
                handleLandClick, selectSeed, oneClickHarvest, oneClickPlant, oneClickClear,
                manualSave, resetData
            };
        }
    }).mount('#app');
</script>
</body>
</html>