# 境界突破系统修改 - 实现说明

## 修改概述

将境界突破加成从固定 `1.05^境界等级` 改为基于"突破跨度"的动态奖励：

```javascript
突破倍率 = 1.1 ^ (当前境界所需N - 上一境界所需N)
```

---

## 修改文件清单

### 1. js/config.js

**添加函数 `getRealmBreakthroughMultiplier(realmIndex)`**
- 计算单次境界突破的倍率
- 基于当前境界与上一境界的N难度差（跨度）

**修改函数 `getRealmBonus(realmIndex)`**
- 从原来的 `1.05^realmIndex`
- 改为遍历累乘每次突破的倍率

```javascript
// 新实现
function getRealmBonus(realmIndex) {
    if (realmIndex <= 0) return new BigNum(1);
    let total = new BigNum(1);
    for (let i = 1; i <= realmIndex; i++) {
        total = total.mul(getRealmBreakthroughMultiplier(i));
    }
    return total;
}
```

---

### 2. js/game/Game.js

**修改方法 `getRealmBonus()`**
- 调用 config.js 中的新实现

**添加方法 `getNextBreakthroughMultiplier()`**
- 预览下一次突破的倍率

**添加方法 `getCurrentBreakthroughSpan()`**
- 计算当前突破的跨度（N难度差）

**修改方法 `updateRealmUI()`**
- 添加跨度和倍率的显示
- 更新按钮文本显示突破倍率

**修改方法 `updateStatsDetailModal()`**
- 添加突破次数显示

---

### 3. index.html

**修改境界面板 (`#tab-realm`)**
- 添加"突破跨度"显示行
- 添加"突破倍率"显示行
- 更新提示文本强调跨度奖励机制

**修改详情弹窗境界部分**
- 添加突破次数显示
- 添加公式说明

---

## 数值对比示例

| 突破阶段 | N跨度 | 旧倍率 | 新倍率 | 累计(旧) | 累计(新) |
|---------|-------|-------|-------|---------|---------|
| 凡人→练气初期 | 3 | 1.05 | **1.33** | 1.05 | **1.33** |
| 练气初期→中期 | 2 | 1.05 | **1.21** | 1.10 | **1.61** |
| 练气圆满→筑基初期 | 14 | 1.05 | **3.80** | 1.37 | **28.1** |
| 筑基圆满→结丹初期 | 30 | 1.05 | **17.4** | 1.81 | **49万** |
| 60境界累计 | - | 18.7 | - | 18.7 | **10^12** |

---

## 效果

### 对玩家体验的影响

1. **大境界突破质变感**
   - 筑基→结丹跨越30层，获得17倍飞跃
   - 相比原来的5%，玩家能清晰感知"蜕变"

2. **小境界稳步成长**
   - 练气初期→中期仅2层，1.21倍温和提升
   - 不至于跳跃过大破坏节奏

3. **后期系统重要性提升**
   - 境界从可有可无的边缘系统
   - 变为与周天、炼体并列的核心增长驱动

### 对平衡的影响

| 方面 | 影响 | 应对措施 |
|-----|------|---------|
| 数值膨胀加速 | 60境界累计从19倍→10^12倍 | 配合转生系统设计 |
| 前期节奏 | N1-N10可能过快 | 观察数据后微调 |
| 敌人强度 | 相对变弱 | 可保持原强度或微调SCALE_ENEMY |

---

## 测试建议

### 关键测试点

1. **首次突破** (凡人→练气初期)
   - 期望：1.33倍，玩家能感知提升
   - 检查：UI显示是否正确

2. **首次大境界** (练气圆满→筑基初期)
   - 期望：3.8倍飞跃感
   - 检查：战力是否明显提升

3. **累计计算** (10次突破后)
   - 期望：累计约28倍
   - 检查：与手动计算是否一致

### 验证代码

```javascript
// 在浏览器控制台测试
// 测试单次突破倍率
getRealmBreakthroughMultiplier(1)  // 应返回 1.331 (跨度3)
getRealmBreakthroughMultiplier(5)  // 应返回 3.797 (跨度14)

// 测试累计倍率
getRealmBonus(5)  // 应返回约 28.12
getRealmBonus(10) // 应返回约 1156
```

---

## 后续优化建议

1. **视觉反馈升级**
   - 大境界突破时（跨度>15）添加全屏特效
   - 小境界突破时添加光效和音效

2. **突破条件丰富**
   - 大境界突破增加材料要求
   - 增加突破失败风险与保险机制

3. **与转生系统协同**
   - 转生后境界重置但加成以印记形式保留
   - 每次转生提升境界成长系数

---

## 回滚方案

如需回滚到旧系统：

1. 恢复 `config.js` 中的 `getRealmBonus` 函数：
```javascript
function getRealmBonus(realmIndex) {
    if (realmIndex <= 0) return new BigNum(1);
    return new BigNum(1.05).pow(realmIndex);
}
```

2. 删除新增的 `getRealmBreakthroughMultiplier` 函数

3. 恢复 `Game.js` 中的 `getRealmBonus` 方法：
```javascript
getRealmBonus() {
    return new BigNum(REALM_BONUS_BASE).pow(this.realmIndex);
}
```

4. 删除新增的 `getNextBreakthroughMultiplier` 和 `getCurrentBreakthroughSpan` 方法

5. 恢复 HTML 中的文本显示

---

**修改完成时间**: 2026-02-17
**修改者**: Claude
**版本**: v1.0
