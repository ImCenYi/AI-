# 功法系统设计文档

## 设计定位

**系统名称**: 功法修炼 (Cultivation Technique)
**核心循环**: 击杀敌人 → 获得灵石 → 消耗灵石修炼功法 → 属性提升
**与现有系统的关系**:
```
荒野刷怪 ──→ 装备（随机掉落）
       └────→ 灵石（固定收益）──→ 功法修炼（稳定成长）
```

**设计意图**:
- 给主线刷怪添加固定收益，降低随机性挫败
- 提供"稳定成长"路径，与装备的"随机成长"形成互补
- 利用已有灵石经济，不新增货币类型

---

## 核心机制设计

### 1. 灵石掉落机制

```javascript
// 在荒野模式击杀敌人时获得
STONE_DROP = {
    // 基础掉落 = 敌人强度相关
    calculateDrop: function(enemyDifficulty, playerStats) {
        // 基于N难度的指数增长
        const baseDrop = new BigNum(10).mul(new BigNum(2).pow(enemyDifficulty * 0.5));

        // 古宝/遗宝加成（如果有相关属性）
        let multiplier = 1;
        if (game.ancientTreasure) {
            multiplier *= game.ancientTreasure.getBonus('stoneGain');
        }

        return baseDrop.mul(multiplier);
    },

    // BOSS额外掉落
    bossBonus: 10,  // BOSS给10倍灵石

    // 自动拾取（无需玩家操作）
    autoCollect: true
};
```

**掉落示例**:
| N难度 | 小怪灵石 | BOSS灵石 |
|-------|----------|----------|
| N1 | 1e1 | 1e2 |
| N10 | 1e2 | 1e3 |
| N50 | 1e8 | 1e9 |
| N100 | 1e16 | 1e17 |

### 2. 功法系统架构

```javascript
// 功法树结构 - 5大系，每系9层
CULTIVATION_TECHNIQUES = {
    // ========== 攻击系 ==========
    attack: {
        name: '七杀剑诀',
        icon: '⚔️',
        desc: '以杀证道，攻击力无限增长',
        maxLayer: 9,
        layers: [
            { name: '剑气初成', cost: 1e3,    bonus: { atkMult: 1.5 } },
            { name: '剑意凝聚', cost: 1e5,    bonus: { atkMult: 2.0 } },
            { name: '剑心通明', cost: 1e8,    bonus: { atkMult: 3.0 } },
            { name: '人剑合一', cost: 1e12,   bonus: { atkMult: 5.0 } },
            { name: '剑破虚空', cost: 1e17,   bonus: { atkMult: 10.0 } },
            { name: '万剑归宗', cost: 1e23,   bonus: { atkMult: 20.0, critChance: 0.05 } },
            { name: '剑域初开', cost: 1e30,   bonus: { atkMult: 50.0, critChance: 0.10 } },
            { name: '剑道通神', cost: 1e40,   bonus: { atkMult: 100.0, critChance: 0.15, atkExpBonus: 0.001 } },
            { name: '一剑开天', cost: 1e55,   bonus: { atkMult: 200.0, critChance: 0.20, atkExpBonus: 0.002 } }
        ]
    },

    // ========== 防御系 ==========
    defense: {
        name: '玄武真经',
        icon: '🛡️',
        desc: '生生不息，防御力无限增长',
        maxLayer: 9,
        layers: [
            { name: '气血充盈', cost: 1e3,    bonus: { hpMult: 1.5 } },
            { name: '铜皮铁骨', cost: 1e5,    bonus: { hpMult: 2.0 } },
            { name: '生生不息', cost: 1e8,    bonus: { hpMult: 3.0, regen: 0.1 } },
            { name: '金刚不坏', cost: 1e12,   bonus: { hpMult: 5.0, regen: 0.2 } },
            { name: '万法不侵', cost: 1e17,   bonus: { hpMult: 10.0, regen: 0.3, damageReduce: 0.1 } },
            { name: '不死之身', cost: 1e23,   bonus: { hpMult: 20.0, regen: 0.5, damageReduce: 0.15 } },
            { name: '滴血重生', cost: 1e30,   bonus: { hpMult: 50.0, regen: 1.0, damageReduce: 0.2 } },
            { name: '永恒之躯', cost: 1e40,   bonus: { hpMult: 100.0, regen: 2.0, damageReduce: 0.25, hpExpBonus: 0.001 } },
            { name: '万劫不灭', cost: 1e55,   bonus: { hpMult: 200.0, regen: 5.0, damageReduce: 0.3, hpExpBonus: 0.002 } }
        ]
    },

    // ========== 效率系 ==========
    efficiency: {
        name: '吞天魔功',
        icon: '⚡',
        desc: '掠夺天地，提升资源获取效率',
        maxLayer: 9,
        layers: [
            { name: '吐纳术', cost: 1e3,    bonus: { stoneGain: 1.5 } },
            { name: '聚灵阵', cost: 1e5,    bonus: { stoneGain: 2.0, dropRate: 1.2 } },
            { name: '灵脉感知', cost: 1e8,    bonus: { stoneGain: 3.0, dropRate: 1.5 } },
            { name: '掠夺术', cost: 1e12,   bonus: { stoneGain: 5.0, dropRate: 2.0, bossStoneBonus: 2 } },
            { name: '吞灵诀', cost: 1e17,   bonus: { stoneGain: 10.0, dropRate: 3.0, bossStoneBonus: 5 } },
            { name: '炼化万物', cost: 1e23,   bonus: { stoneGain: 20.0, dropRate: 5.0, equipSalvageBonus: 2 } },
            { name: '灵气化海', cost: 1e30,   bonus: { stoneGain: 50.0, dropRate: 10.0, autoStoneGain: 0.1 } },
            { name: '天道掠夺', cost: 1e40,   bonus: { stoneGain: 100.0, dropRate: 20.0, autoStoneGain: 0.5 } },
            { name: '吞天噬地', cost: 1e55,   bonus: { stoneGain: 200.0, dropRate: 50.0, autoStoneGain: 1.0, allResourceExpBonus: 0.001 } }
        ]
    },

    // ========== 法则系 ==========
    law: {
        name: '悟道心经',
        icon: '☯️',
        desc: '感悟天地法则，加速法则修炼',
        maxLayer: 9,
        unlockRequirement: { realmIndex: 10 },  // 筑基期解锁
        layers: [
            { name: '初窥门径', cost: 1e6,    bonus: { lawGain: 1.5 } },
            { name: '明心见性', cost: 1e9,    bonus: { lawGain: 2.0 } },
            { name: '道法自然', cost: 1e13,   bonus: { lawGain: 3.0, lawCostReduce: 0.9 } },
            { name: '天人合一', cost: 1e19,   bonus: { lawGain: 5.0, lawCostReduce: 0.8 } },
            { name: '悟透本源', cost: 1e26,   bonus: { lawGain: 10.0, lawCostReduce: 0.7, towerDropBonus: 2 } },
            { name: '法则亲和', cost: 1e35,   bonus: { lawGain: 20.0, lawCostReduce: 0.6, towerDropBonus: 5 } },
            { name: '言出法随', cost: 1e48,   bonus: { lawGain: 50.0, lawCostReduce: 0.5, freeLawLevels: 3 } },
            { name: '法则之主', cost: 1e65,   bonus: { lawGain: 100.0, lawCostReduce: 0.4, freeLawLevels: 10 } },
            { name: '一念成道', cost: 1e90,   bonus: { lawGain: 200.0, lawCostReduce: 0.3, freeLawLevels: 30, lawExpBonus: 0.001 } }
        ]
    },

    // ========== 本源系（高阶解锁）==========
    essence: {
        name: '混沌本源功',
        icon: '🌌',
        desc: '追溯本源，全属性指数级提升',
        maxLayer: 9,
        unlockRequirement: { realmIndex: 50, reincarnationCount: 1 },  // 需要一定进度
        layers: [
            { name: '初触本源', cost: 1e20,   bonus: { allStatsMult: 2.0 } },
            { name: '本源亲和', cost: 1e30,   bonus: { allStatsMult: 3.0 } },
            { name: '本源融合', cost: 1e45,   bonus: { allStatsMult: 5.0, allStatsExpBonus: 0.001 } },
            { name: '本源掌控', cost: 1e65,   bonus: { allStatsMult: 10.0, allStatsExpBonus: 0.002 } },
            { name: '本源化身', cost: 1e90,   bonus: { allStatsMult: 20.0, allStatsExpBonus: 0.003 } },
            { name: '本源不灭', cost: 1e120,  bonus: { allStatsMult: 50.0, allStatsExpBonus: 0.004 } },
            { name: '本源创世', cost: 1e160,  bonus: { allStatsMult: 100.0, allStatsExpBonus: 0.005 } },
            { name: '本源永恒', cost: 1e210,  bonus: { allStatsMult: 200.0, allStatsExpBonus: 0.007 } },
            { name: '混沌归一', cost: 1e280,  bonus: { allStatsMult: 500.0, allStatsExpBonus: 0.01 } }
        ]
    }
};
```

### 3. 功法修炼规则

```javascript
TECHNIQUE_RULES = {
    // 可同时修炼多系功法
    maxActiveTechniques: 5,

    // 每系功法必须按顺序修炼（不能跳层）
    requireSequential: true,

    // 灵石消耗是永久消耗（不像法则可以保留真意）
    consumeOnPurchase: true,

    // 功法加成永久生效，不可重置
    permanent: true,

    // 特殊机制：功法共鸣
    // 当多个系达到一定层数时，触发额外加成
    resonance: {
        'attack-defense': {
            require: { attack: 3, defense: 3 },
            bonus: { atkMult: 1.2, hpMult: 1.2 }
        },
        'all-five': {
            require: { attack: 5, defense: 5, efficiency: 5, law: 5, essence: 5 },
            bonus: { allStatsMult: 3.0, allStatsExpBonus: 0.005 }
        }
    }
};
```

### 4. 与现有系统的数值耦合

```javascript
// 在Game.getTotalStats()中加入功法加成
getTotalStats() {
    let stats = { ...this.playerBase };

    // ... 现有计算（装备、法则、境界等）...

    // 新增：功法加成
    if (this.techniques) {
        const techBonuses = this.techniques.getTotalBonuses();

        // 攻击加成
        stats.atk = stats.atk.mul(techBonuses.atkMult);
        if (techBonuses.critChance) {
            stats.crit += techBonuses.critChance;
        }
        if (techBonuses.atkExpBonus) {
            stats.atk = stats.atk.expBonus(techBonuses.atkExpBonus);
        }

        // 生命加成
        stats.maxHp = stats.maxHp.mul(techBonuses.hpMult);
        if (techBonuses.hpExpBonus) {
            stats.maxHp = stats.maxHp.expBonus(techBonuses.hpExpBonus);
        }

        // 全属性加成
        if (techBonuses.allStatsMult) {
            stats.atk = stats.atk.mul(techBonuses.allStatsMult);
            stats.maxHp = stats.maxHp.mul(techBonuses.allStatsMult);
        }
        if (techBonuses.allStatsExpBonus) {
            stats.atk = stats.atk.expBonus(techBonuses.allStatsExpBonus);
            stats.maxHp = stats.maxHp.expBonus(techBonuses.allStatsExpBonus);
        }
    }

    return stats;
}

// 在掉落计算中加入功法加成
calculateStoneDrop(enemy) {
    let baseDrop = calculateBaseDrop(enemy);

    // 功法加成
    if (this.techniques) {
        const bonus = this.techniques.getBonus('stoneGain');
        baseDrop = baseDrop.mul(bonus);

        // BOSS额外加成
        if (enemy.isBoss) {
            const bossBonus = this.techniques.getBonus('bossStoneBonus');
            baseDrop = baseDrop.mul(bossBonus);
        }

        // 自动灵石获取（离线/在线挂机）
        const autoGain = this.techniques.getBonus('autoStoneGain');
        if (autoGain > 0) {
            this.passiveStoneGain = baseDrop.mul(autoGain * 0.01);  // 每秒自动获得1%的掉落量
        }
    }

    return baseDrop;
}
```

---

## UI设计

### 1. 功法主界面

```
┌─────────────────────────────────────────┐
│  📚 功法修炼                              │
│  当前灵石: 1.25e48                        │
├─────────────────────────────────────────┤
│                                          │
│  【七杀剑诀】⚔️  [ Lv.3/9 ]               │
│  当前: 剑心通明    攻击力×3              │
│  下一层: 人剑合一  攻击力×5  消耗1e12    │
│  [ 突破 ]                                │
│  ─────────────────────────────────────  │
│                                          │
│  【玄武真经】🛡️  [ Lv.2/9 ]               │
│  当前: 铜皮铁骨    生命值×2              │
│  下一层: 生生不息  生命值×3  消耗1e8     │
│  [ 突破 ]                                │
│  ─────────────────────────────────────  │
│                                          │
│  【吞天魔功】⚡  [ Lv.4/9 ]               │
│  当前: 掠夺术      灵石获取×5            │
│  下一层: 吞灵诀    灵石获取×10 消耗1e17  │
│  [ 突破 ]                                │
│  ─────────────────────────────────────  │
│                                          │
│  【悟道心经】☯️  [ 未解锁 ]               │
│  解锁条件: 境界达到筑基期                │
│  ─────────────────────────────────────  │
│                                          │
│  【混沌本源功】🌌 [ 未解锁 ]              │
│  解锁条件: 境界达到化神期，轮回1次       │
│                                          │
├─────────────────────────────────────────┤
│  功法共鸣                                 │
│  ✓ 攻守兼备: 剑诀Lv3 + 玄武Lv3 = 攻防×1.2│
│  ☐ 五行圆满: 全系Lv5 = 全属性×3          │
└─────────────────────────────────────────┘
```

### 2. 属性加成预览

```
┌─────────────────────────────────────────┐
│  功法加成总览                            │
├─────────────────────────────────────────┤
│                                          │
│  攻击加成: ×180  (来自剑诀Lv8)           │
│  生命加成: ×200  (来自玄武Lv9)           │
│  暴击率: +15%    (来自剑诀Lv8)           │
│  灵石获取: ×100  (来自魔功Lv8)           │
│  ─────────────────────────────────────  │
│  总属性倍率: ×3    (来自本源Lv5)         │
│  总属性指数: +0.8% (来自各系终极层)      │
│                                          │
│  [ 查看详情 ]                            │
└─────────────────────────────────────────┘
```

---

## 数值平衡设计

### 1. 成本与收益曲线

| 层数 | 灵石成本 | 攻击收益 | 生命收益 | 效率收益 | 累计攻击倍率 |
|------|----------|----------|----------|----------|--------------|
| 1 | 1e3 | ×1.5 | ×1.5 | ×1.5 | 1.5 |
| 2 | 1e5 | ×2.0 | ×2.0 | ×2.0 | 3.0 |
| 3 | 1e8 | ×3.0 | ×3.0 | ×3.0 | 9.0 |
| 4 | 1e12 | ×5.0 | ×5.0 | ×5.0 | 45 |
| 5 | 1e17 | ×10.0 | ×10.0 | ×10.0 | 450 |
| 6 | 1e23 | ×20.0 | ×20.0 | ×20.0 | 9000 |
| 7 | 1e30 | ×50.0 | ×50.0 | ×50.0 | 45万 |
| 8 | 1e40 | ×100.0 | ×100.0 | ×100.0 | 4500万 |
| 9 | 1e55 | ×200.0 | ×200.0 | ×200.0 | 90亿 |

### 2. 与其他系统的平衡

```javascript
// 功法系统定位：中期主力，后期补充
BALANCE_POSITION = {
    // 中期(N50-N200): 功法提供主要成长
    midGame: {
        contribution: '30-40% of total power',
        purpose: '稳定成长，降低装备随机性的影响'
    },

    // 后期(N200+): 功法成为基础，其他系统提供爆发
    lateGame: {
        contribution: '10-20% of total power',
        purpose: '提供基础属性，让其他百分比加成更有意义'
    }
};

// 防止功法一家独大
CAP_MECHANISMS = {
    // 灵石获取有上限（基于N难度）
    maxStonePerKill: (N) => new BigNum(10).pow(N * 0.6),

    // 功法层数有上限（9层）
    maxLayer: 9,

    // 指数加成严格控制
    maxExpBonusFromTech: 0.01  // 最高1%
};
```

### 3. 灵石经济平衡

```javascript
// 灵石来源分配
STONE_ECONOMY = {
    sources: {
        killing: '40%',      // 击杀掉落
        garden: '35%',       // 灵园产出（现有）
        salvage: '15%',      // 装备熔炼（现有）
        other: '10%'         // 其他
    },

    sinks: {
        techniques: '50%',   // 功法修炼（新增主要消耗）
        garden: '30%',       // 灵园种植（现有）
        other: '20%'         // 其他
    }
};

// 确保玩家不会无限积累灵石
STONE_SINK_DESIGN = {
    // 功法消耗指数增长，最终消耗天文数字
    // 第9层需要1e55灵石，而N100每次击杀只给1e16
    // 需要击杀1e39次才能凑够，实际不可能
    // 因此玩家必须提升N难度来获取更多灵石

    // 设计意图：灵石永远不够用，推动玩家继续挑战更高N
};
```

---

## 实施步骤

### Phase 1: 基础框架
1. 创建 `Technique.js` 类
2. 实现灵石掉落机制（加入Game的击杀处理）
3. 添加功法数据结构
4. 基础UI（功法列表、突破按钮）

### Phase 2: 数值耦合
1. 将功法加成接入 `getTotalStats()`
2. 实现灵石消耗逻辑
3. 添加功法共鸣检测
4. 数值平衡调试

### Phase 3: 高级功能
1. 功法推荐系统（根据玩家build推荐优先升级的功法）
2. 功法成就（如"九剑齐出"-剑诀满级）
3. 功法皮肤/特效（满级后改变技能特效）

---

## 与其他设计的关系

### 与轮回转世系统的结合

如果实现了轮回转世系统，功法系统可以这样配合：

```javascript
// 轮回时保留功法进度（因为是永久投资）
KEEP_ON_REINCARNATION.push('techniques');

// 轮回印商店可以卖功法相关商品
REINCARNATION_SHOP.push({
    id: 'techniqueReset',
    name: '功法洗髓',
    cost: 50,
    effect: () => {
        // 返还部分灵石，重置所有功法到0
        const refund = calculateTotalSpent().mul(0.5);
        game.stones = game.stones.add(refund);
        game.techniques.reset();
    }
});
```

### 与奇遇系统的结合

```javascript
MIRACLE_TYPES.push({
    id: 'ancient_manual',
    name: '上古功法残卷',
    effect: () => {
        // 立即免费提升一层功法
        game.techniques.freeUpgradeOneLayer();
    }
});
```

---

## 总结

**功法系统解决了什么问题**:
1. 给主线刷怪添加固定收益，降低"刷了10分钟啥也没掉"的挫败感
2. 提供稳定成长路径，与装备的随机性形成互补
3. 增加灵石消耗出口，让灵石经济更有价值

**关键设计决策**:
1. 使用现有灵石货币，不新增货币类型
2. 指数级成本增长，确保玩家永远有追求
3. 9层上限 + 指数加成控制，防止后期崩坏
4. 功法共鸣鼓励多系发展，而非单系点满

**预期效果**:
- 中期玩家约30-40%实力来自功法
- 后期玩家约10-20%实力来自功法
- 功法成为"基础属性"，让其他系统的百分比加成更有意义
