# 轮回转世系统设计文档

## 设计定位

**系统名称**: 轮回转世 (Reincarnation)
**设计目标**: 引入短期重置循环，解决卡关等待的无聊感，提供流派选择空间
**与境界系统的关系**:
```
境界突破 ──→ 永久性成长线（不会回退）
     ↓
轮回转世 ──→ 周期性重置线（短期循环）
     ↓
最终属性 = 境界加成 × 轮回加成 × 其他系统
```

---

## 核心设计原则

### 1. 保护已有投资
**绝不重置**: 境界、古宝、遗宝、星窍、法则层数、灵园进度
**部分重置**: N难度、装备、当前灵石
**完全重置**: 临时BUFF、当前战斗状态

### 2. 快速回归机制
轮回后N1-N50的敌人大幅削弱，让玩家在1-2小时内回到原难度的80%

### 3. 有意义的抉择
每次轮回获得"道心"，用于购买"道蕴"（永久加成，但可洗点），形成流派选择

---

## 详细机制设计

### 1. 轮回触发条件

```javascript
REINCARNATION_CONFIG = {
    // 首次解锁条件
    unlockRequirement: {
        realmIndex: 20,        // 元婴期解锁
        maxDifficulty: 50,     // 或达到N50
        description: "感悟轮回真意，即可开启转世重修之路"
    },

    // 轮回收益计算公式
    calculateGain: function(currentN, historyMaxN, reincarnationCount) {
        // 基础道心 = log(历史最高N难度) × 系数
        let baseDaoxin = Math.log10(historyMaxN) * 100;

        // 轮回次数衰减（防止刷次数）
        let countPenalty = Math.max(0.5, 1 - (reincarnationCount * 0.05));

        // 当前N与历史最高比（鼓励冲新高）
        let progressBonus = (currentN / historyMaxN) * 0.5 + 0.5;

        return Math.floor(baseDaoxin * countPenalty * progressBonus);
    }
}
```

### 2. 轮回重置内容

```javascript
// ========== 保留的项目（玩家已有的长期投资）==========
KEEP_LIST = [
    // 核心养成系统
    'realmIndex',              // 境界进度
    'lawCultivation',          // 法则修炼层数
    'ancientTreasure',         // 大千宝录古宝
    'abyssRelic',              // 深渊遗宝
    'zhouTian',                // 周天星窍
    'garden',                  // 灵园（包括土地解锁、灵植解锁）
    'lifeEssenceRefinement',   // 炼体锻身

    // 轮回系统本身
    'reincarnationCount',      // 轮回次数
    'purchasedDaoyun',         // 已购买的道蕴（永久保留）
    'totalDaoxinEarned',       // 历史累计道心（成就用）
];

// ========== 重置的项目（短期进度）==========
RESET_LIST = [
    'currentDifficulty',       // 当前N难度 → 回到1
    'maxDifficultyThisRun',    // 本轮最高N → 清零
    'equipment',               // 所有装备 → 清空
    'treasureBag',             // 秘宝宝箱 → 清空
    'currentStones',           // 当前灵石 → 清空（但保留灵园库存）
    'currentPills',            // 当前丹药 → 清空
    'currentHp',               // 当前生命 → 满血
];

// ========== 特殊处理 ==========
SPECIAL_HANDLE = {
    // 灵石处理：给少量启动资金
    startingStones: function(reincarnationCount) {
        return 100 * Math.pow(1.5, reincarnationCount);
    },

    // 装备保护：轮回前穿戴的最好装备，轮回后立即返还1件
    protectedEquipment: function(equippedItems) {
        // 选择评分最高的一件
        return bestItem;
    }
};
```

### 3. 快速回归机制（关键设计）

```javascript
// 轮回后N难度的"压缩"机制
FAST_RETURN = {
    // 轮回后敌人HP/ATK = 正常值 × 衰减系数
    getEnemyReduction: function(currentN, reincarnationCount) {
        // N1-N20: 敌人只有正常强度的10%
        if (currentN <= 20) return 0.1;

        // N21-N50: 线性恢复到正常强度
        if (currentN <= 50) {
            return 0.1 + (currentN - 20) * 0.03;  // 10% → 100%
        }

        // N50+: 正常强度
        return 1.0;
    },

    // 装备掉落等级补偿
    getDropBonus: function(currentN, maxNLastRun) {
        // 轮回后掉落的装备等级 = 当前N + (上轮最高N × 0.5)
        // 这样玩家能快速获得接近原来的装备
        return currentN + Math.floor(maxNLastRun * 0.5);
    },

    // 灵石获取加成
    getStoneBonus: function(currentN) {
        // N1-N30: 5倍灵石获取
        if (currentN <= 30) return 5.0;
        // N31-N50: 2倍灵石获取
        if (currentN <= 50) return 2.0;
        return 1.0;
    }
};
```

**设计意图**: 让玩家在轮回后的1-2小时内快速回到上轮80%的强度，而不是从头慢慢爬。

### 4. 道心获取与用途

#### 4.1 道心获取

```javascript
// 轮回时获得的资源
REINCARNATION_REWARD = {
    // 主要奖励
    daoxin: calculateGain(),    // 道心（用于购买道蕴）

    // 额外奖励（轮回次数里程碑）
    milestoneRewards: {
        1: { type: 'title', value: '初入轮回', desc: '首次轮回纪念称号' },
        5: { type: 'multiplier', value: 1.1, desc: '道心获取+10%' },
        10: { type: 'unlock', value: 'autoReincarnate', desc: '解锁自动轮回' },
        25: { type: 'multiplier', value: 1.2, desc: '道心获取+20%' },
        50: { type: 'special', value: 'eternalMemory', desc: '轮回后保留1件装备' },
        100: { type: 'unlock', value: 'dualPath', desc: '解锁双道蕴栏位' }
    }
};
```

#### 4.2 道蕴系统（道心用途）

```javascript
// 道蕴 = 消耗道心购买的永久加成（可洗点重选）
DAOYUN_TREE = {
    // ========== 战斗分支 ==========
    combat: {
        name: '战狂之道',
        icon: '⚔️',
        maxPoints: 100,
        bonuses: [
            { id: 'atkPercent', name: '锐气', desc: '攻击力+5%/级', max: 50, cost: 10 },
            { id: 'critChance', name: '暴击', desc: '暴击率+1%/级', max: 25, cost: 15 },
            { id: 'critDamage', name: '破甲', desc: '暴击伤害+10%/级', max: 25, cost: 15 },
            { id: 'bossDamage', name: '斩首', desc: '对BOSS伤害+10%/级', max: 20, cost: 20 },
            { id: 'atkExponent', name: '破境', desc: '攻击力指数+0.02%/级(终极)', max: 10, cost: 100 }
        ]
    },

    // ========== 生存分支 ==========
    survival: {
        name: '不朽之身',
        icon: '🛡️',
        maxPoints: 100,
        bonuses: [
            { id: 'hpPercent', name: '气血', desc: '生命值+5%/级', max: 50, cost: 10 },
            { id: 'regen', name: '回春', desc: '生命回复+10%/级', max: 30, cost: 15 },
            { id: 'damageReduce', name: '铁壁', desc: '受到伤害-2%/级', max: 25, cost: 20 },
            { id: 'hpExponent', name: '长生', desc: '生命值指数+0.02%/级(终极)', max: 10, cost: 100 }
        ]
    },

    // ========== 资源分支 ==========
    resource: {
        name: '聚宝灵体',
        icon: '💰',
        maxPoints: 100,
        bonuses: [
            { id: 'dropRate', name: '幸运', desc: '装备掉率+5%/级', max: 40, cost: 10 },
            { id: 'stoneGain', name: '聚财', desc: '灵石获取+10%/级', max: 30, cost: 15 },
            { id: 'pillEfficiency', name: '丹道', desc: '丹药效果+10%/级', max: 25, cost: 20 },
            { id: 'equipLevel', name: '神匠', desc: '装备等级+1/级', max: 50, cost: 25 },
            { id: 'gardenYield', name: '灵植', desc: '灵园产出+10%/级', max: 20, cost: 20 }
        ]
    },

    // ========== 效率分支 ==========
    efficiency: {
        name: '万法皆通',
        icon: '⚡',
        maxPoints: 100,
        bonuses: [
            { id: 'lawGain', name: '悟道', desc: '法则真意+10%/级', max: 30, cost: 15 },
            { id: 'towerDrop', name: '通天', desc: '爬塔掉率+10%/级', max: 30, cost: 15 },
            { id: 'dungeonToken', name: '寻宝', desc: '寻宝令获取+10%/级', max: 25, cost: 20 },
            { id: 'reincarnationGain', name: '轮回', desc: '道心获取+10%/级', max: 20, cost: 25 },
            { id: 'fastReturn', name: '归途', desc: '轮回快速回归期+N5/级', max: 10, cost: 30 }
        ]
    },

    // ========== 特殊分支（高轮回次数解锁）==========
    special: {
        name: '超脱之道',
        icon: '☯️',
        unlockRequirement: { reincarnationCount: 10 },
        maxPoints: 50,
        bonuses: [
            { id: 'allStatExponent', name: '无极', desc: '全属性指数+0.05%/级', max: 20, cost: 200 },
            { id: 'startDifficulty', name: '起点', desc: '轮回起始N难度+5/级', max: 10, cost: 500 },
            { id: 'keepEquipment', name: '铭记', desc: '轮回保留装备+N件/级', max: 5, cost: 1000 }
        ]
    }
};
```

#### 4.3 洗点机制

```javascript
RESPEC_CONFIG = {
    // 免费洗点次数（每次轮回获得1次）
    freeRespecPerReincarnation: 1,

    // 额外洗点消耗
    respecCost: function(timesUsed) {
        return 100 * Math.pow(2, timesUsed);  // 100, 200, 400, 800...
    },

    // 洗点后返还
    refundRate: 0.9  // 返还90%道心（有损耗，防止无限试错）
};
```

### 5. 与现有系统的耦合

#### 5.1 属性计算链更新

```javascript
// 在Game.getTotalStats()中加入轮回加成
getTotalStats() {
    let stats = { ...this.playerBase };

    // ... 现有计算 ...

    // 新增：轮回道蕴加成
    if (this.reincarnation) {
        const daoyunBonuses = this.reincarnation.getActiveBonuses();

        // 乘算加成
        stats.atk = stats.atk.mul(daoyunBonuses.atkMultiplier);
        stats.maxHp = stats.maxHp.mul(daoyunBonuses.hpMultiplier);

        // 指数加成
        if (daoyunBonuses.atkExponent > 0) {
            stats.atk = stats.atk.expBonus(daoyunBonuses.atkExponent);
        }
        if (daoyunBonuses.hpExponent > 0) {
            stats.maxHp = stats.maxHp.expBonus(daoyunBonuses.hpExponent);
        }

        // 其他加成应用到对应系统...
    }

    return stats;
}
```

#### 5.2 掉落系统耦合

```javascript
// 在掉落计算中加入道蕴加成
calculateDrop() {
    let baseRate = 0.05 + 0.01 * this.difficulty;

    // 道蕴-幸运加成
    if (this.reincarnation) {
        baseRate *= (1 + this.reincarnation.getBonus('dropRate'));
    }

    // 装备等级加成
    let baseLevel = this.difficulty;
    if (this.reincarnation) {
        baseLevel += this.reincarnation.getBonus('equipLevel');
    }

    return { rate: baseRate, level: baseLevel };
}
```

#### 5.3 快速回归UI反馈

```javascript
// 轮回后的特殊UI状态
showReincarnationStatus() {
    if (this.isInFastReturnPeriod()) {
        const currentN = this.difficulty;
        const reduction = this.getEnemyReduction(currentN);

        // 显示快速回归BUFF图标
        showBuffIcon({
            name: '轮回真意',
            desc: `敌人削弱 ${(1-reduction)*100}%，快速回归中`,
            remaining: `${currentN}/50`
        });

        // N50时播放特效提示回归完成
        if (currentN === 50) {
            showEffect('回归完成，恢复正常难度');
        }
    }
}
```

---

## UI设计

### 1. 轮回主界面

```
┌─────────────────────────────────────────┐
│  ☯️ 轮回转世                              │
├─────────────────────────────────────────┤
│                                          │
│  当前轮回次数: 12 次                      │
│  累计获得道心: 12,580                     │
│                                          │
│  ┌─────────────┐  ┌─────────────┐        │
│  │  轮回收益    │  │  道蕴修炼    │        │
│  │  预览       │  │  (洗点重选)   │        │
│  └─────────────┘  └─────────────┘        │
│                                          │
│  ─────────────────────────────────────  │
│  当前N难度: N127                          │
│  本轮最高N: N127                          │
│  预计获得道心: 215                        │
│                                          │
│  [ 🔴 立即轮回 ]                          │
│  (重置N难度，获得道心，快速回归)           │
│                                          │
│  [checkbox] 启用自动轮回 (N150触发)        │
│                                          │
└─────────────────────────────────────────┘
```

### 2. 道蕴树界面

```
┌─────────────────────────────────────────┐
│  道蕴修炼 - 剩余道心: 580                 │
├─────────────────────────────────────────┤
│                                          │
│  [战狂] [不朽] [聚宝] [万法] [超脱🔒]     │
│                                          │
│  ─── 战狂之道 ───                        │
│  ⚔️ 攻击力强化                            │
│  ├─ 锐气 Lv.25/50  +125%攻击  [+]        │
│  ├─ 暴击 Lv.10/25  +10%暴击率  [+]        │
│  ├─ 破甲 Lv.5/25   +50%暴伤   [+]        │
│  ├─ 斩首 Lv.0/20   未激活     [+]        │
│  └─ 破境 Lv.0/10   🔒需50点前置         │
│                                          │
│  本分支已投入: 40/100 点                  │
│                                          │
│  [重置本分支] (消耗1次免费洗点)            │
│  [重置全部] (返还90%道心)                 │
│                                          │
└─────────────────────────────────────────┘
```

---

## 数值平衡参考

### 预期成长曲线

| 轮回次数 | 历史最高N | 获得道心 | 累计道心 | 轮回加成估算 | 实际提升 |
|----------|-----------|----------|----------|--------------|----------|
| 1 | 50 | 200 | 200 | ×1.2 | 可打到N55 |
| 5 | 80 | 280 | 1200 | ×1.8 | 可打到N100 |
| 10 | 120 | 350 | 3000 | ×3.0 | 可打到N180 |
| 25 | 200 | 450 | 8000 | ×6.0 | 可打到N350 |
| 50 | 350 | 600 | 18000 | ×12.0 | 可打到N600 |

### 关键平衡点

```javascript
BALANCE_CHECKPOINTS = {
    // 首次轮回后应该能突破之前的瓶颈
    firstReincarnation: {
        before: '卡关在N50',
        after: '可打到N55-60',
        timeToReturn: '1小时内回到N45+'
    },

    // 10次轮回后应该感受到质变
    tenthReincarnation: {
        bonus: '约×3总加成',
        breakthrough: '可打到原境界的2倍N难度'
    },

    // 长期循环不崩坏
    longTerm: {
        // 即使有100次轮回，加成也控制在合理范围
        maxMultiplier: 100,  // ×100
        maxExponent: 0.05,   // +5%指数
        // 配合境界系统的×10000，轮回系统不喧宾夺主
    }
};
```

---

## 实施步骤

### Phase 1: 基础框架
1. 创建 `Reincarnation.js` 类
2. 实现轮回触发与重置逻辑
3. 添加基础UI（轮回按钮、道心显示）

### Phase 2: 道蕴系统
1. 实现道蕴树数据结构
2. 实现加点/洗点逻辑
3. 将道蕴加成接入属性计算链

### Phase 3: 快速回归
1. 实现敌人削弱机制
2. 实现掉落补偿机制
3. 添加回归进度UI提示

### Phase 4: 高级功能
1. 自动轮回功能
2. 轮回里程碑奖励
3. 超脱之道分支解锁

---

## 风险评估与应对

| 风险 | 可能性 | 影响 | 应对策略 |
|------|--------|------|----------|
| 玩家不愿意重置 | 高 | 系统废弃 | 强化快速回归，首次轮回给丰厚奖励 |
| 洗点成本过高 | 中 | 玩家不满 | 每次轮回给免费洗点，降低试错成本 |
| 流派平衡性差 | 中 | 全员同质化 | 根据数据调整各分支数值，避免最优解 |
| 与境界系统冲突 | 低 | 数值崩坏 | 严格控制轮回加成上限，作为辅助而非替代 |

---

**文档版本**: v1.0
**设计状态**: 待评审/可进入实现阶段
