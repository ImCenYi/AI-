# 功法系统重构设计文档

## 一、系统概述

### 1.1 设计目标
- 简化功法系统，使其更容易理解和使用
- 仿 Clicker Heroes 的数值设计，提供清晰的成长曲线
- 增加神通系统作为功法修炼的里程碑奖励
- 灵石作为独立资源，仅通过击杀主线敌人获得

### 1.2 核心循环
```
击杀主线敌人 → 获得灵石 → 修炼功法 → 属性提升 → 击杀更强敌人
```

---

## 二、灵石系统

### 2.1 获取方式
**仅通过击杀主线模式（wild）敌人获得**

### 2.2 掉落规则
| 参数 | 数值 | 说明 |
|------|------|------|
| 基础值 | 1-3 随机 | 每个敌人固定范围 |
| 难度加成 | ×1.5^(难度-1) | 难度1=x1, 难度2=x1.5, 难度3=x2.25... |
| 灵石袋概率 | 0.1% | 触发时获得100倍灵石 |
| 灵石袋倍数 | ×100 | 独立乘算 |

### 2.3 掉落示例
- 难度1: 1-3 灵石
- 难度5: 5-15 灵石
- 难度10: 38-113 灵石
- 难度20: 2,210-6,633 灵石 (触发灵石袋时 221,000-663,300)

---

## 三、功法系统

### 3.1 功法列表 (共7个)

| 序号 | 功法名 | 类型 | 效果 | 成本增长 | 解锁条件 |
|------|--------|------|------|----------|----------|
| 1 | 金刚诀 | 攻击 | 攻击力 ×1.1/级 | ×2/级 | 开局解锁 |
| 2 | 玄武心经 | 生命 | 生命值 ×1.1/级 | ×2/级 | 开局解锁 |
| 3 | 采药术 | 丹药数量 | 丹药掉落数量 ×2/级 | ×5/级 | 开局解锁 |
| 4 | 炼丹诀 | 丹药效果 | 丹药效果 ×2/级 | ×5/级 | 开局解锁 |
| 5 | 悟道心法 | 真意掉率 | 真意掉率 ×10/级 | ×1000/级 | 金刚诀10级 |
| 6 | 诛仙剑诀 | 攻击 | 攻击力 ×15/级 | ×10/级 | 玄武心经20级 |
| 7 | 不灭金身 | 生命 | 生命值 ×15/级 | ×10/级 | 采药术20级 |

### 3.2 成本计算
**公式**: 总成本 = BaseCost × (Scale^Target - Scale^Current) / (Scale - 1)

**示例** (金刚诀从0到10级):
- 基础成本: 10
- 成本增长: ×2
- 总成本 = 10 × (2^10 - 1) / (2-1) = 10 × 1023 = 10,230 灵石

### 3.3 效果计算
**公式**: 总倍率 = EffectScale^Layer × 神通倍率

**示例** (金刚诀10级+人剑合一神通):
- 基础倍率: 1.1^10 = 2.59
- 神通倍率: ×2
- 总倍率 = 2.59 × 2 = 5.18

---

## 四、神通系统

### 4.1 解锁条件
每个功法达到特定等级时解锁神通选项：
- **5级**: 解锁第1个神通
- **10级**: 解锁第2个神通
- **15级**: 解锁第3个神通

### 4.2 神通列表

#### 金刚诀神通
| 等级 | 神通名 | 效果 | 成本倍数 |
|------|--------|------|----------|
| 5 | 剑气初成 | 攻击力+50% | 5×基础成本 |
| 10 | 人剑合一 | 攻击力+100% | 10×基础成本 |
| 15 | 万剑归宗 | 攻击力+200% | 20×基础成本 |

#### 玄武心经神通
| 等级 | 神通名 | 效果 | 成本倍数 |
|------|--------|------|----------|
| 5 | 铜皮铁骨 | 生命值+50% | 5×基础成本 |
| 10 | 生生不息 | 生命值+100% | 10×基础成本 |
| 15 | 滴血重生 | 生命值+200% | 20×基础成本 |

#### 采药术神通
| 等级 | 神通名 | 效果 | 成本倍数 |
|------|--------|------|----------|
| 5 | 识草术 | 丹药掉落+50% | 5×基础成本 |
| 10 | 灵草感应 | 丹药掉落+100% | 10×基础成本 |
| 15 | 百草之王 | 丹药掉落+200% | 20×基础成本 |

#### 炼丹诀神通
| 等级 | 神通名 | 效果 | 成本倍数 |
|------|--------|------|----------|
| 5 | 火候精通 | 丹药效果+50% | 5×基础成本 |
| 10 | 丹纹天成 | 丹药效果+100% | 10×基础成本 |
| 15 | 九转金丹 | 丹药效果+200% | 20×基础成本 |

#### 悟道心法神通
| 等级 | 神通名 | 效果 | 成本倍数 |
|------|--------|------|----------|
| 5 | 初窥天道 | 真意掉率+50% | 5×基础成本 |
| 10 | 天人合一 | 真意掉率+100% | 10×基础成本 |
| 15 | 道法自然 | 真意掉率+200% | 20×基础成本 |

#### 诛仙剑诀神通
| 等级 | 神通名 | 效果 | 成本倍数 |
|------|--------|------|----------|
| 5 | 剑意纵横 | 攻击力+100% | 5×基础成本 |
| 10 | 一剑破万法 | 攻击力+300% | 10×基础成本 |
| 15 | 诛仙剑阵 | 攻击力+500% | 20×基础成本 |

#### 不灭金身神通
| 等级 | 神通名 | 效果 | 成本倍数 |
|------|--------|------|----------|
| 5 | 金刚不坏 | 生命值+100% | 5×基础成本 |
| 10 | 肉身成圣 | 生命值+300% | 10×基础成本 |
| 15 | 不死不灭 | 生命值+500% | 20×基础成本 |

---

## 五、系统集成

### 5.1 属性加成集成点

```javascript
// Game.js getTotalStats() 中:

// 1. 攻击加成 (功法1 + 功法6)
if (techBonuses.atkMult > 1) {
    stats.atk = stats.atk.mul(techBonuses.atkMult);
}

// 2. 生命加成 (功法2 + 功法7)
if (techBonuses.hpMult > 1) {
    maxHp = maxHp.mul(techBonuses.hpMult);
}
```

### 5.2 丹药系统集成

```javascript
// Game.js rollWildLoot() 中:

// 丹药效果倍率 (功法4)
if (this.technique) {
    const techBonuses = this.technique.getAllBonuses();
    if (techBonuses.pillMult > 1) {
        pillMult = pillMult.mul(techBonuses.pillMult);
    }
}
```

### 5.3 真意掉率集成

```javascript
// Game.js rollTowerLoot() 中:

// 真意掉率加成 (功法5)
if (this.technique) {
    const techBonuses = this.technique.getAllBonuses();
    if (techBonuses.essenceDrop > 1) {
        drop = drop.mul(techBonuses.essenceDrop);
    }
}
```

---

## 六、修炼暴击机制

### 6.1 机制说明
每次点击"+1"升级时，有概率触发**修炼暴击**，获得额外层数提升。

| 参数 | 数值 | 说明 |
|------|------|------|
| 触发概率 | 5% | 每次单级升级独立判定 |
| 暴击效果 | 连升3级 | 原本1级 → 实际3级 |
| 消耗计算 | 只扣1级成本 | 省掉2级的灵石消耗 |

### 6.2 暴击示例
- **正常升级**: 消耗100灵石，从Lv.5 → Lv.6
- **触发暴击**: 消耗100灵石，从Lv.5 → Lv.8（省掉Lv.6→Lv.7和Lv.7→Lv.8的成本约300灵石）

### 6.3 UI反馈
- 升级按钮显示暴击概率（⚡5%）
- 触发暴击时显示特殊日志："🎆 修炼暴击！功法名 +3级！"

---

## 七、灵石掉落跳字

### 7.1 机制说明
击杀主线敌人时，在敌人位置显示浮动的灵石数量。

### 7.2 显示格式
```
💎 123
```
- 图标：💎 灵石图标
- 数值：格式化的灵石数量
- 颜色：绿色 (#10b981)

### 7.3 动画效果
- 初始：正常大小，不透明
- 中间：上浮20px，轻微放大到1.1倍
- 结束：上浮40px，缩小到0.9倍，淡出
- 总时长：1秒

### 7.4 触发条件
- 仅在主线模式（wild）击杀敌人时触发
- 每次击杀都显示（无论数量多少）

---

## 七、数值平衡参考

### 7.1 功法1-4 早期成长 (成本/收益)

| 等级 | 金刚诀累计成本 | 攻击倍率 | 玄武心经累计成本 | 生命倍率 |
|------|----------------|----------|------------------|----------|
| 5 | 310 | ×1.61 | 310 | ×1.61 |
| 10 | 10,230 | ×2.59 | 10,230 | ×2.59 |
| 15 | 327,660 | ×4.18 | 327,660 | ×4.18 |
| 20 | 10,485,740 | ×6.73 | 10,485,740 | ×6.73 |

### 6.2 功法5-7 后期成长

| 等级 | 悟道心法累计成本 | 真意倍率 | 诛仙剑诀累计成本 | 攻击倍率 |
|------|------------------|----------|------------------|----------|
| 5 | 1.11M | ×100K | 111K | ×7.6M |
| 10 | 1.11T | ×10B | 11.1M | ×576M |

---

## 七、代码文件结构

```
js/
├── config.js              # TECHNIQUE_CONFIG 配置
├── classes/
│   └── Technique.js       # 功法系统核心类
└── game/
    └── Game.js            # 集成逻辑

index.html                 # UI布局
```

---

## 八、关键技术点

### 8.1 BuyMax 算法
```javascript
// 求最大可升等级
// S = a × (r^n - 1) / (r - 1)
// n = log(S × (r-1)/a + 1) / log(r)
const maxLayer = Math.floor(
    Math.log(available * (scale - 1) / base + 1) / Math.log(scale)
);
```

### 8.2 序列化/反序列化
```javascript
// 保存: 层数、解锁状态、已购神通、总消耗
// 加载: 恢复所有状态并刷新UI
```

---

## 九、界面设计

### 9.1 功法列表卡片
- **头部**: 图标 + 名称 + 属性类别标签 + 当前等级
- **倍率显示**: 当前功法提供的总倍率
- **升级按钮**: +1 (显示成本+暴击概率) + MAX (BuyMax)
- **暴击提示**: 触发暴击时显示特殊动画和日志
- **神通区域**: 可购买的神通列表（带成本）
- **已购神通**: 标签形式展示

### 9.2 顶部统计
- **灵石数量**: 💎 实时显示
- **加成总览**: 5个维度的当前总倍率

---

## 十、后续扩展建议

1. **更多功法**: 增加暴击率、暴击伤害、装备掉率等类型
2. **功法组合**: 特定功法组合激活额外加成
3. **神通树**: 神通之间形成依赖关系，构建build
4. **灵石加成**: 增加全局灵石获取倍率的功法/神通
5. **自动修炼**: 解锁后自动购买最高性价比功法
